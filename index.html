<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROGRAMA C√ìRDOBA 25/26 - Datos Actualizados Autom√°ticamente</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }
        
        /* PANTALLA DE LOGIN */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            transition: opacity 0.5s ease;
        }
        
        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px solid #2E7D32;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-icon {
            font-size: 32px;
            margin-bottom: 20px;
            color: #2E7D32;
        }
        
        .login-title {
            color: #2E7D32;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #000000;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .login-button {
            background-color: #2E7D32;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .login-button:hover {
            background-color: #1B5E20;
        }
        
        .login-error {
            margin-top: 15px;
            color: #f44336;
            font-size: 13px;
            font-weight: bold;
            display: none;
        }
        
        /* T√çTULO SUPERIOR */
        #tituloApp {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #2E7D32;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
            max-width: 250px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: none; /* Oculto hasta login */
        }
        
        /* BOT√ìN ACTUALIZAR */
        #btnActualizar {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
            display: none; /* Oculto hasta login */
        }
        
        /* BOT√ìN GR√ÅFICOS */
        #btnGraficos {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #2E7D32;
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            font-size: 26px;
            transition: all 0.3s;
            display: none; /* Oculto hasta login */
        }
        
        #btnGraficos:hover {
            background-color: #2196F3;
            transform: scale(1.1);
        }
        
        /* BUSCADOR */
        #buscadorClientes {
            position: fixed;
            top: 100px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #1E88E5;
            z-index: 999;
            font-family: Arial, sans-serif;
            font-size: 12px;
            width: 240px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: none; /* Oculto hasta login */
        }
        
        /* LEYENDA PRECIPITACI√ìN */
        #leyendaPrecip {
            position: fixed;
            bottom: 40px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 10px 14px;
            border-radius: 8px;
            border: 2px solid #1E88E5;
            z-index: 999;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 150px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* LEYENDA CULTIVOS */
        #leyendaCultivos {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            z-index: 999;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 180px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            display: none; /* Oculto hasta login */
        }
        
        /* PANEL GR√ÅFICOS */
        #panelGraficos {
            position: fixed;
            bottom: -85%;
            left: 0;
            width: 100%;
            height: 85%;
            background-color: white;
            z-index: 10001;
            box-shadow: 0 -3px 15px rgba(0,0,0,0.3);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            transition: bottom 0.4s ease;
            overflow-y: auto;
            font-family: Arial, sans-serif;
            display: none;
        }
        
        /* PANEL DE CARGA */
        #cargandoPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 10px;
            border: 3px solid #2E7D32;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            min-width: 300px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E7D32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* MENSAJE ERROR */
        #mensajeError {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffebee;
            color: #c62828;
            padding: 20px 30px;
            border-radius: 8px;
            border: 2px solid #c62828;
            z-index: 2000;
            text-align: center;
            max-width: 400px;
            display: none;
        }
        
        .color-box {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
            border: 1px solid #333;
            border-radius: 2px;
        }
        
        /* ANIMACI√ìN SHAKE PARA LOGIN */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <h2 class="login-title">PROGRAMA C√ìRDOBA 25/26</h2>
            <p class="login-subtitle">Acceso restringido</p>
            
            <div class="login-input-group">
                <label class="login-label">üë§ Usuario</label>
                <input type="text" id="loginUsuario" class="login-input" placeholder="Ingrese su usuario">
            </div>
            
            <div class="login-input-group">
                <label class="login-label">üîí Contrase√±a</label>
                <input type="password" id="loginContrasena" class="login-input" placeholder="Ingrese su contrase√±a">
            </div>
            
            <button id="loginButton" class="login-button">üîì INGRESAR AL SISTEMA</button>
            
            <div id="loginError" class="login-error">
                ‚ùå Usuario o contrase√±a incorrectos
            </div>
            
            <div style="margin-top: 25px; font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 15px;">
                Programa C√≥rdoba 25/26
            </div>
        </div>
    </div>
    
    <!-- MAPA -->
    <div id="map"></div>
    
    <!-- T√çTULO APP -->
    <div id="tituloApp">
        <h1>üåΩ PROGRAMA C√ìRDOBA 25/26</h1>
        <div id="infoCarga">
            <div>üîÑ <span id="estadoCarga">Esperando login...</span></div>
            <div>üìÖ <span id="fechaActualizacion">√öltima actualizaci√≥n: --/--/-- --:--</span></div>
            <div>üìç <span id="contadorPoligonos">0 pol√≠gonos</span></div>
        </div>
    </div>
    
    <!-- BOT√ìN ACTUALIZAR -->
    <button id="btnActualizar" onclick="actualizarDatos()">
        üîÑ Actualizar datos
    </button>
    
    <!-- PANEL DE CARGA -->
    <div id="cargandoPanel">
        <div class="spinner"></div>
        <h2>Cargando datos actualizados</h2>
        <p>Conectando con GitHub...</p>
        <div id="progresoCarga" style="margin-top: 15px; font-size: 12px; color: #666;">
            Preparando descarga...
        </div>
    </div>
    
    <!-- BOT√ìN GR√ÅFICOS -->
    <div id="btnGraficos" onclick="togglePanelGraficos()">
        üìä
    </div>
    
    <!-- BUSCADOR CLIENTES -->
    <div id="buscadorClientes">
        <!-- Se llenar√° con JavaScript -->
    </div>
    
    <!-- LEYENDA PRECIPITACI√ìN -->
    <div id="leyendaPrecip">
        <!-- Se llenar√° con JavaScript -->
    </div>
    
    <!-- LEYENDA CULTIVOS -->
    <div id="leyendaCultivos">
        <!-- Se llenar√° con JavaScript -->
    </div>
    
    <!-- PANEL GR√ÅFICOS -->
    <div id="panelGraficos">
        <!-- Se llenar√° con JavaScript -->
    </div>
    
    <!-- MENSAJE ERROR -->
    <div id="mensajeError">
        <!-- Se llenar√° con JavaScript -->
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Dependencias Folium -->
    <script src="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.css" />
    
    <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
    
    <!-- C√≥digo principal -->
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const USUARIO_CORRECTO = "Sancor";
        const CONTRASENA_CORRECTA = "2025Sancor";
        const GEOJSON_URL = 'https://raw.githubusercontent.com/franciscotomatis/APP-C-rdoba/main/datos_actualizados.geojson';
        const HECTAREAS_PROYECTADAS = {
            "1": 84940,
            "2": 155256,
            "3": 158675,
            "4": 134574
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map;
        let geoLayer;
        let geojsonData = null;
        let campoCliente = null;
        let campoCultivo = null;
        let campoHectareas = null;
        let campoZona = null;
        let boundsGeneral = null;
        let panelGraficosAbierto = false;
        
        // ============================================
        // 1. SISTEMA DE LOGIN
        // ============================================
        
        function verificarLogin() {
            const usuario = document.getElementById('loginUsuario').value.trim();
            const contrasena = document.getElementById('loginContrasena').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!usuario || !contrasena) {
                errorDiv.textContent = '‚ùå Por favor, complete ambos campos';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (usuario === USUARIO_CORRECTO && contrasena === CONTRASENA_CORRECTA) {
                // Login exitoso
                errorDiv.style.display = 'none';
                
                // Animaci√≥n de salida del login
                const loginScreen = document.getElementById('loginScreen');
                loginScreen.style.opacity = '0';
                
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    
                    // Mostrar elementos de la app
                    document.getElementById('tituloApp').style.display = 'block';
                    document.getElementById('btnActualizar').style.display = 'block';
                    document.getElementById('btnGraficos').style.display = 'flex';
                    
                    // Inicializar mapa
                    inicializarMapa();
                    
                    // Cargar datos autom√°ticamente
                    cargarDatosDesdeGitHub();
                    
                }, 500);
                
            } else {
                // Credenciales incorrectas
                errorDiv.textContent = '‚ùå Usuario o contrase√±a incorrectos';
                errorDiv.style.display = 'block';
                document.getElementById('loginContrasena').value = '';
                document.getElementById('loginContrasena').focus();
                
                // Animaci√≥n de error
                const loginBox = document.querySelector('.login-box');
                loginBox.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    loginBox.style.animation = '';
                }, 500);
            }
        }
        
        // Configurar eventos de login
        document.getElementById('loginButton').addEventListener('click', verificarLogin);
        
        document.getElementById('loginUsuario').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginContrasena').focus();
            }
        });
        
        document.getElementById('loginContrasena').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verificarLogin();
            }
        });
        
        // Verificar si ya hay sesi√≥n activa (7 d√≠as)
        function verificarSesionActiva() {
            const sesionValida = localStorage.getItem('sesion_valida');
            const ultimoAcceso = localStorage.getItem('ultimo_acceso');
            
            if (sesionValida === 'true' && ultimoAcceso) {
                const ultimaFecha = new Date(ultimoAcceso);
                const ahora = new Date();
                const diferenciaDias = (ahora - ultimaFecha) / (1000 * 60 * 60 * 24);
                
                if (diferenciaDias < 7) {
                    // Sesi√≥n v√°lida, saltar login
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('tituloApp').style.display = 'block';
                    document.getElementById('btnActualizar').style.display = 'block';
                    document.getElementById('btnGraficos').style.display = 'flex';
                    
                    inicializarMapa();
                    cargarDatosDesdeGitHub();
                    return true;
                } else {
                    // Sesi√≥n expirada
                    localStorage.removeItem('sesion_valida');
                    localStorage.removeItem('ultimo_acceso');
                }
            }
            return false;
        }
        
        // ============================================
        // 2. INICIALIZAR MAPA
        // ============================================
        function inicializarMapa() {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            // Centro de C√≥rdoba
            const center = [-31.4201, -64.1888];
            
            // Crear mapa
            map = L.map('map', {
                center: center,
                zoom: 11,
                controlScale: true,
                zoomControl: true
            });
            
            // Agregar capas base (IGUAL QUE TU APP)
            L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                name: 'üåç Google Sat√©lite',
                maxZoom: 20
            }).addTo(map);
            
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                name: 'üó∫Ô∏è Google H√≠brido',
                maxZoom: 20
            }).addTo(map);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB',
                name: 'üåô Modo oscuro',
                maxZoom: 20
            }).addTo(map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                name: 'üåê OpenStreetMap',
                maxZoom: 20
            }).addTo(map);
            
            // Agregar controles (IGUAL QUE TU APP)
            L.control.layers({}, {}, {
                position: 'topright',
                collapsed: true
            }).addTo(map);
            
            // Control pantalla completa
            L.control.fullscreen({
                position: 'topright',
                title: 'Pantalla completa',
                titleCancel: 'Salir pantalla completa'
            }).addTo(map);
            
            // Control de medidas
            L.control.measure({
                position: 'topright',
                primaryLengthUnit: 'kilometers',
                secondaryLengthUnit: 'meters',
                primaryAreaUnit: 'hectares',
                secondaryAreaUnit: 'sqmeters'
            }).addTo(map);
            
            console.log('‚úÖ Mapa inicializado');
        }
        
        // ============================================
        // 3. CARGAR DATOS DESDE GITHUB
        // ============================================
        async function cargarDatosDesdeGitHub() {
            console.log('üì° Cargando datos desde GitHub...');
            
            // Mostrar panel de carga
            document.getElementById('cargandoPanel').style.display = 'block';
            actualizarEstadoCarga('Conectando con GitHub...');
            
            try {
                // Mostrar progreso
                document.getElementById('progresoCarga').textContent = 'Descargando GeoJSON...';
                
                const response = await fetch(GEOJSON_URL);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                document.getElementById('progresoCarga').textContent = 'Procesando datos...';
                const data = await response.json();
                geojsonData = data;
                
                console.log('‚úÖ Datos cargados:', data);
                
                // Guardar sesi√≥n
                localStorage.setItem('sesion_valida', 'true');
                localStorage.setItem('ultimo_acceso', new Date().toISOString());
                
                // Procesar datos
                procesarDatos(data);
                
                // Ocultar panel de carga
                document.getElementById('cargandoPanel').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                mostrarError(`Error al cargar datos: ${error.message}`);
                document.getElementById('cargandoPanel').style.display = 'none';
            }
        }
        
        // ============================================
        // 4. FUNCIONES DE PROCESAMIENTO (SIMILARES A TU APP)
        // ============================================
        
        function procesarDatos(data) {
            if (!data || !data.features || data.features.length === 0) {
                mostrarError('No hay datos para mostrar');
                return;
            }
            
            // Encontrar campos autom√°ticamente
            encontrarCamposClave(data.features[0].properties);
            
            // Contar pol√≠gonos
            const numPoligonos = data.features.length;
            actualizarContadorPoligonos(numPoligonos);
            
            // Calcular estad√≠sticas
            const estadisticas = calcularEstadisticas(data);
            
            // Crear capa GeoJSON
            crearCapaGeoJSON(data);
            
            // Crear leyenda de cultivos
            crearLeyendaCultivos(estadisticas.superficiePorCultivo, estadisticas.totalSuperficie);
            
            // Crear buscador de clientes
            if (campoCliente) {
                crearBuscadorClientes(estadisticas.clientesUnicos);
            }
            
            // Crear leyenda de precipitaci√≥n
            crearLeyendaPrecipitacion();
            
            // Crear panel de gr√°ficos
            crearPanelGraficos(estadisticas.hectareasPorZona);
            
            // Actualizar fecha de √∫ltima actualizaci√≥n
            actualizarFechaActualizacion();
            
            console.log('‚úÖ Datos procesados');
        }
        
        function encontrarCamposClave(propiedades) {
            // Buscar campo cliente
            const posiblesClientes = ['CLIENTE', 'cliente', 'Cliente', 'NOMBRE_CLIENTE'];
            for (const campo of posiblesClientes) {
                if (propiedades[campo] !== undefined) {
                    campoCliente = campo;
                    break;
                }
            }
            
            // Buscar campo cultivo
            const posiblesCultivos = ['CULTIVO', 'cultivo', 'Cultivo', 'CROP', 'crop'];
            for (const campo of posiblesCultivos) {
                if (propiedades[campo] !== undefined) {
                    campoCultivo = campo;
                    break;
                }
            }
            
            // Buscar campo hect√°reas
            const posiblesHectareas = ['HECTAREAS_ASEGURADAS', 'HECTAREAS_DECLARADAS', 'hectareas', 'HECTAREAS', 'HAS', 'has'];
            for (const campo of posiblesHectareas) {
                if (propiedades[campo] !== undefined) {
                    campoHectareas = campo;
                    break;
                }
            }
            
            // Buscar campo zona
            const posiblesZonas = ['ZONA_CZ4', 'ZONA', 'Zona', 'zona', 'CZ4'];
            for (const campo of posiblesZonas) {
                if (propiedades[campo] !== undefined) {
                    campoZona = campo;
                    break;
                }
            }
        }
        
        function calcularEstadisticas(data) {
            const estadisticas = {
                superficiePorCultivo: {},
                totalSuperficie: 0,
                hectareasPorZona: {},
                clientesUnicos: new Set()
            };
            
            // Calcular superficie por cultivo
            if (campoCultivo && campoHectareas) {
                data.features.forEach(feature => {
                    const cultivo = feature.properties[campoCultivo];
                    const hectareas = parseFloat(feature.properties[campoHectareas]) || 0;
                    
                    if (cultivo) {
                        if (!estadisticas.superficiePorCultivo[cultivo]) {
                            estadisticas.superficiePorCultivo[cultivo] = 0;
                        }
                        estadisticas.superficiePorCultivo[cultivo] += hectareas;
                        estadisticas.totalSuperficie += hectareas;
                    }
                });
            }
            
            // Calcular hect√°reas por zona
            if (campoZona && campoHectareas) {
                data.features.forEach(feature => {
                    const zona = String(feature.properties[campoZona] || '').trim();
                    const hectareas = parseFloat(feature.properties[campoHectareas]) || 0;
                    
                    if (zona) {
                        if (!estadisticas.hectareasPorZona[zona]) {
                            estadisticas.hectareasPorZona[zona] = 0;
                        }
                        estadisticas.hectareasPorZona[zona] += hectareas;
                    }
                });
            }
            
            // Obtener clientes √∫nicos
            if (campoCliente) {
                data.features.forEach(feature => {
                    const cliente = feature.properties[campoCliente];
                    if (cliente) {
                        estadisticas.clientesUnicos.add(String(cliente).trim());
                    }
                });
            }
            
            return estadisticas;
        }
        
        function crearCapaGeoJSON(data) {
            // Funci√≥n de estilo por cultivo (IGUAL QUE TU APP)
            function estiloPorCultivo(feature) {
                let colorRelleno = '#9C27B0';
                let colorBorde = '#7B1FA2';
                
                if (campoCultivo && feature.properties[campoCultivo]) {
                    const cultivo = String(feature.properties[campoCultivo]).toLowerCase();
                    
                    if (cultivo.includes('soja') || cultivo.includes('soya')) {
                        colorRelleno = '#4CAF50';
                        colorBorde = '#2E7D32';
                    } else if (cultivo.includes('ma√≠z') || cultivo.includes('maiz') || cultivo.includes('corn')) {
                        colorRelleno = '#FFC107';
                        colorBorde = '#FF8F00';
                    } else if (cultivo.includes('trigo') || cultivo.includes('wheat')) {
                        colorRelleno = '#795548';
                        colorBorde = '#5D4037';
                    } else if (cultivo.includes('girasol') || cultivo.includes('sunflower')) {
                        colorRelleno = '#FF9800';
                        colorBorde = '#EF6C00';
                    } else if (cultivo.includes('algod√≥n') || cultivo.includes('algodon') || cultivo.includes('cotton')) {
                        colorRelleno = '#2196F3';
                        colorBorde = '#1976D2';
                    } else if (cultivo.includes('sorgo') || cultivo.includes('sorghum')) {
                        colorRelleno = '#E91E63';
                        colorBorde = '#C2185B';
                    }
                }
                
                feature.properties._color_fill = colorRelleno;
                feature.properties._color_border = colorBorde;
                
                return {
                    fillColor: colorRelleno,
                    color: colorBorde,
                    weight: 2,
                    fillOpacity: 0.6,
                    dashArray: '5, 5'
                };
            }
            
            // Funci√≥n highlight
            function highlightFeature(e) {
                const layer = e.target;
                layer.setStyle({
                    fillColor: '#FF5722',
                    color: '#D84315',
                    weight: 3,
                    fillOpacity: 0.8,
                    dashArray: '5, 5'
                });
            }
            
            function resetHighlight(e) {
                geoLayer.resetStyle(e.target);
            }
            
            // Crear capa
            geoLayer = L.geoJSON(data, {
                style: estiloPorCultivo,
                onEachFeature: function(feature, layer) {
                    // Tooltip
                    if (campoCliente && feature.properties[campoCliente]) {
                        layer.bindTooltip(feature.properties[campoCliente], {
                            sticky: true,
                            className: 'leaflet-tooltip-custom'
                        });
                    }
                    
                    // Popup
                    const popupContent = crearContenidoPopup(feature.properties);
                    layer.bindPopup(popupContent, {
                        maxWidth: 350,
                        maxHeight: 400,
                        className: 'leaflet-popup-custom'
                    });
                    
                    // Eventos
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight
                    });
                }
            }).addTo(map);
            
            // Guardar bounds
            boundsGeneral = geoLayer.getBounds();
            if (boundsGeneral.isValid()) {
                map.fitBounds(boundsGeneral);
            }
            
            // Mostrar elementos de UI
            document.getElementById('buscadorClientes').style.display = 'block';
            document.getElementById('leyendaCultivos').style.display = 'block';
            document.getElementById('leyendaPrecip').style.display = 'block';
        }
        
        function crearContenidoPopup(propiedades) {
            let contenido = '<div style="font-family: Arial; font-size: 12px; max-width: 300px;">';
            
            const camposImportantes = [
                'CUIT', 'CLIENTE', 'CAMPO', 'DEPARTAMENTO', 'LOCALIDAD', 
                'CULTIVO', 'LOTE', 'CULTIVO_ANTERIOR', 'RENDIMIENTO_ANTERIOR',
                'HECTAREAS_DECLARADAS', 'HECTAREAS_ASEGURADAS', 'PORCENTAJE_ASEGURADO',
                'ZONA_CZ4', 'RENDIMIENTO_ASEGURADO', 'SUMA_ASEGURADA', 'FECHA_CREACION'
            ];
            
            camposImportantes.forEach(campo => {
                if (propiedades[campo] !== undefined && propiedades[campo] !== null && propiedades[campo] !== '') {
                    contenido += `<div><b>${campo}:</b> ${propiedades[campo]}</div>`;
                }
            });
            
            contenido += '</div>';
            return contenido;
        }
        
        // ============================================
        // 5. FUNCIONES DE INTERFAZ
        // ============================================
        
        function actualizarEstadoCarga(mensaje) {
            document.getElementById('estadoCarga').textContent = mensaje;
        }
        
        function actualizarContadorPoligonos(num) {
            document.getElementById('contadorPoligonos').textContent = `${num.toLocaleString()} pol√≠gonos`;
        }
        
        function actualizarFechaActualizacion() {
            const ahora = new Date();
            const fechaStr = ahora.toLocaleDateString('es-AR');
            const horaStr = ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('fechaActualizacion').textContent = `√öltima actualizaci√≥n: ${fechaStr} ${horaStr}`;
        }
        
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('mensajeError');
            errorDiv.innerHTML = `
                <h3>‚ùå Error</h3>
                <p>${mensaje}</p>
                <button onclick="cargarDatosDesdeGitHub()" style="margin-top: 10px; padding: 5px 15px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Reintentar
                </button>
            `;
            errorDiv.style.display = 'block';
        }
        
        function actualizarDatos() {
            document.getElementById('btnActualizar').innerHTML = 'üîÑ Actualizando...';
            cargarDatosDesdeGitHub();
            setTimeout(() => {
                document.getElementById('btnActualizar').innerHTML = 'üîÑ Actualizar datos';
            }, 2000);
        }
        
        function togglePanelGraficos() {
            const panel = document.getElementById('panelGraficos');
            const btn = document.getElementById('btnGraficos');
            
            if (panelGraficosAbierto) {
                panel.style.bottom = '-85%';
                panel.style.zIndex = '9998';
                btn.innerHTML = 'üìä';
                btn.style.backgroundColor = '#2E7D32';
            } else {
                panel.style.zIndex = '10001';
                panel.style.bottom = '0';
                panel.style.display = 'block';
                btn.innerHTML = 'üìà';
                btn.style.backgroundColor = '#2196F3';
            }
            panelGraficosAbierto = !panelGraficosAbierto;
        }
        
        // ============================================
        // 6. INICIALIZAR APLICACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            
            // Verificar sesi√≥n activa
            if (!verificarSesionActiva()) {
                // Mostrar login si no hay sesi√≥n
                document.getElementById('loginUsuario').focus();
            }
            
            // Configurar auto-actualizaci√≥n cada 30 minutos
            setInterval(() => {
                if (document.getElementById('loginScreen').style.display === 'none') {
                    actualizarDatos();
                }
            }, 30 * 60 * 1000);
        });
        
        // ============================================
        // 7. FUNCIONES PARA BUSCADOR, LEYENDAS Y GR√ÅFICOS
        // ============================================
        
        // Estas funciones son largas, las colocar√© en un archivo separado
        // para mantener el c√≥digo organizado
        
    </script>
    
    <!-- Cargar funciones adicionales desde tu repositorio -->
    <script src="https://raw.githubusercontent.com/franciscotomatis/APP-C-rdoba/main/funciones-adicionales.js"></script>
    
</body>
</html>
