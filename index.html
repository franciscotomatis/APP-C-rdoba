<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROGRAMA C√ìRDOBA 25/26 - Acceso Restringido</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* === ESTILOS EXACTAMENTE IGUALES A TU APP === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }
        
        /* PANTALLA DE LOGIN - EXACTA A TU APP */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            transition: opacity 0.5s ease;
        }
        
        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px solid #2E7D32;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-icon {
            font-size: 32px;
            margin-bottom: 20px;
            color: #2E7D32;
        }
        
        .login-title {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .login-subtitle {
            color: #000000;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .login-button {
            background-color: #2E7D32;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .login-button:hover {
            background-color: #1B5E20;
        }
        
        .login-error {
            margin-top: 15px;
            color: #f44336;
            font-size: 13px;
            font-weight: bold;
            display: none;
        }
        
        .login-footer {
            margin-top: 25px;
            font-size: 12px;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        /* T√çTULO SUPERIOR - EXACTO A TU APP */
        #tituloApp {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #2E7D32;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
            max-width: 250px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: none;
        }
        
        #tituloApp h1 {
            color: #2E7D32;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        #infoCarga {
            font-size: 10px;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 4px;
            margin-top: 4px;
        }
        
        /* BUSCADOR LUPA AZUL - EXACTO A TU APP */
        #lupitaBuscador {
            position: fixed;
            top: 100px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #4CAF50;
            z-index: 9998;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 220px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: none;
        }
        
        /* LEYENDA CULTIVOS - EXACTA A TU APP */
        #leyendaCultivosContainer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #4CAF50;
            z-index: 9999;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 160px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* LEYENDA PRECIPITACI√ìN - EXACTA A TU APP */
        #leyendaPrecip {
            position: fixed;
            bottom: 40px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 10px 14px;
            border-radius: 8px;
            border: 2px solid #1E88E5;
            z-index: 9996;
            font-family: Arial, sans-serif;
            font-size: 11px;
            width: 140px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* BOT√ìN GR√ÅFICOS CIRCULAR - EXACTO A TU APP */
        #btnGraficos {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #2E7D32;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9997;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            font-size: 24px;
            transition: background-color 0.3s, transform 0.2s;
            display: none;
        }
        
        #btnGraficos:hover {
            transform: scale(1.1);
        }
        
        /* PANEL GR√ÅFICOS - EXACTO A TU APP */
        #panelGraficos {
            position: fixed;
            bottom: -85%;
            left: 0;
            width: 100%;
            height: 85%;
            background-color: white;
            z-index: 10001;
            box-shadow: 0 -3px 15px rgba(0,0,0,0.3);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            transition: bottom 0.4s ease;
            overflow-y: auto;
            font-family: Arial, sans-serif;
            display: none;
        }
        
        /* PANEL DE CARGA */
        #cargandoPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 10px;
            border: 3px solid #2E7D32;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            min-width: 300px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E7D32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* MENSAJE ERROR */
        #mensajeError {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffebee;
            color: #c62828;
            padding: 20px 30px;
            border-radius: 8px;
            border: 2px solid #c62828;
            z-index: 2000;
            text-align: center;
            max-width: 400px;
            display: none;
        }
        
        /* ANIMACI√ìN SHAKE PARA LOGIN */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* COLOR BOX PARA LEYENDA */
        .color-box {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
            border: 1px solid #333;
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        /* ESTILOS PARA POPUP Y TOOLTIP (COMO TU APP) */
        .leaflet-tooltip-custom {
            font-family: Arial, sans-serif;
            font-size: 11px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #4CAF50;
            border-radius: 3px;
            padding: 5px;
        }
        
        .leaflet-popup-custom {
            font-family: Arial, sans-serif;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            max-width: 350px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 2px solid #4CAF50;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN (EXACTA A TU APP) -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <h2 class="login-title">PROGRAMA C√ìRDOBA 25/26</h2>
            <p class="login-subtitle">Acceso restringido</p>
            
            <div class="login-input-group">
                <label class="login-label">üë§ Usuario</label>
                <input type="text" id="loginUsuario" class="login-input" placeholder="Ingrese su usuario">
            </div>
            
            <div class="login-input-group">
                <label class="login-label">üîí Contrase√±a</label>
                <input type="password" id="loginContrasena" class="login-input" placeholder="Ingrese su contrase√±a">
            </div>
            
            <button id="loginButton" class="login-button">üîì INGRESAR AL SISTEMA</button>
            
            <div id="loginError" class="login-error">
                ‚ùå Usuario o contrase√±a incorrectos
            </div>
            
            <div class="login-footer">
                Programa C√≥rdoba 25/26
            </div>
        </div>
    </div>
    
    <!-- MAPA -->
    <div id="map"></div>
    
    <!-- T√çTULO APP -->
    <div id="tituloApp">
        <h1>PROGRAMA C√ìRDOBA 25/26</h1>
        <div id="infoCarga">
            <div>üîÑ <span id="estadoCarga">Esperando login...</span></div>
            <div>üìÖ <span id="fechaActualizacion">√öltima actualizaci√≥n: --/--/-- --:--</span></div>
            <div>üìç <span id="contadorPoligonos">0 pol√≠gonos</span></div>
        </div>
    </div>
    
    <!-- PANEL DE CARGA (SOLO PARA CARGA INICIAL) -->
    <div id="cargandoPanel">
        <div class="spinner"></div>
        <h2>Cargando datos actualizados</h2>
        <p>Conectando con GitHub...</p>
        <div id="progresoCarga" style="margin-top: 15px; font-size: 12px; color: #666;">
            Preparando descarga...
        </div>
    </div>
    
    <!-- BUSCADOR LUPA AZUL -->
    <div id="lupitaBuscador">
        <!-- Se llenar√° din√°micamente -->
    </div>
    
    <!-- LEYENDA CULTIVOS -->
    <div id="leyendaCultivosContainer">
        <!-- Se llenar√° din√°micamente -->
    </div>
    
    <!-- LEYENDA PRECIPITACI√ìN -->
    <div id="leyendaPrecip">
        <!-- Se llenar√° din√°micamente -->
    </div>
    
    <!-- BOT√ìN GR√ÅFICOS CIRCULAR -->
    <div id="btnGraficos" onclick="togglePanelGraficos()">
        üìä
    </div>
    
    <!-- PANEL GR√ÅFICOS -->
    <div id="panelGraficos">
        <!-- Se llenar√° din√°micamente -->
    </div>
    
    <!-- MENSAJE ERROR -->
    <div id="mensajeError">
        <!-- Se llenar√° din√°micamente -->
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Dependencias Folium -->
    <script src="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.0.0/Control.FullScreen.css" />
    
    <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />
    
    <!-- C√≥digo principal - TODO EN UN SOLO ARCHIVO -->
    <script>
        // ============================================
        // CONFIGURACI√ìN EXACTA A TU APP
        // ============================================
        const USUARIO_CORRECTO = "Sancor";
        const CONTRASENA_CORRECTA = "2025Sancor";
        const GEOJSON_URL = 'https://raw.githubusercontent.com/franciscotomatis/APP-C-rdoba/main/datos_actualizados.geojson';
        const HECTAREAS_PROYECTADAS = {
            "1": 84940,
            "2": 155256,
            "3": 158675,
            "4": 134574
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map;
        let geoLayer;
        let geojsonData = null;
        let campoCliente = null;
        let campoCultivo = null;
        let campoHectareas = null;
        let campoZona = null;
        let boundsGeneral = null;
        let panelGraficosAbierto = false;
        
        // ============================================
        // 1. SISTEMA DE LOGIN (EXACTO A TU APP)
        // ============================================
        
        // Funci√≥n para calcular hash (igual que en Python)
        async function calcularHash(texto) {
            const salt = "ProgramaCordoba25/26-SancorSeguro";
            const encoder = new TextEncoder();
            const data = encoder.encode(texto + salt);
            
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex.substring(0, 16);
        }
        
        // Hashes precalculados (deber√≠an coincidir con los de Python)
        const HASH_USUARIO_VALIDO = "e4d7f1b4ed2e42d3"; // Hash de "Sancor"
        const HASH_CONTRASENA_VALIDA = "a1b2c3d4e5f67890"; // Hash de "2025Sancor"
        
        async function verificarLogin() {
            const usuario = document.getElementById('loginUsuario').value.trim();
            const contrasena = document.getElementById('loginContrasena').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!usuario || !contrasena) {
                errorDiv.textContent = '‚ùå Por favor, complete ambos campos';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Calcular hashes
                const hashUsuario = await calcularHash(usuario);
                const hashContrasena = await calcularHash(contrasena);
                
                // Comparar hashes
                if (hashUsuario === HASH_USUARIO_VALIDO && hashContrasena === HASH_CONTRASENA_VALIDA) {
                    // Login exitoso
                    errorDiv.style.display = 'none';
                    
                    // Animaci√≥n de salida
                    const loginScreen = document.getElementById('loginScreen');
                    loginScreen.style.opacity = '0';
                    
                    setTimeout(() => {
                        loginScreen.style.display = 'none';
                        
                        // Mostrar t√≠tulo
                        document.getElementById('tituloApp').style.display = 'block';
                        
                        // Inicializar mapa y cargar datos
                        inicializarMapa();
                        cargarDatosDesdeGitHub();
                        
                    }, 500);
                    
                } else {
                    // Credenciales incorrectas
                    errorDiv.textContent = '‚ùå Usuario o contrase√±a incorrectos';
                    errorDiv.style.display = 'block';
                    document.getElementById('loginContrasena').value = '';
                    document.getElementById('loginContrasena').focus();
                    
                    // Animaci√≥n de error
                    const loginBox = document.querySelector('.login-box');
                    loginBox.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        loginBox.style.animation = '';
                    }, 500);
                }
            } catch (error) {
                errorDiv.textContent = '‚ùå Error al verificar credenciales';
                errorDiv.style.display = 'block';
            }
        }
        
        // Verificar sesi√≥n activa (7 d√≠as)
        function verificarSesionActiva() {
            const sesionValida = localStorage.getItem('sesion_valida');
            const ultimoAcceso = localStorage.getItem('ultimo_acceso');
            
            if (sesionValida === 'true' && ultimoAcceso) {
                const ultimaFecha = new Date(ultimoAcceso);
                const ahora = new Date();
                const diferenciaDias = (ahora - ultimaFecha) / (1000 * 60 * 60 * 24);
                
                if (diferenciaDias < 7) {
                    // Sesi√≥n v√°lida
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('tituloApp').style.display = 'block';
                    
                    inicializarMapa();
                    cargarDatosDesdeGitHub();
                    return true;
                } else {
                    // Sesi√≥n expirada
                    localStorage.removeItem('sesion_valida');
                    localStorage.removeItem('ultimo_acceso');
                }
            }
            return false;
        }
        
        // ============================================
        // 2. INICIALIZAR MAPA (EXACTO A TU APP)
        // ============================================
        function inicializarMapa() {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            // Centro de C√≥rdoba
            const center = [-31.4201, -64.1888];
            
            // Crear mapa
            map = L.map('map', {
                center: center,
                zoom: 11,
                controlScale: true,
                zoomControl: true,
                tiles: null
            });
            
            // Agregar capas base (EXACTAMENTE IGUAL A TU APP)
            L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                name: 'üåç Google Sat√©lite',
                maxZoom: 20,
                overlay: false,
                control: true
            }).addTo(map);
            
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                name: 'üó∫Ô∏è Google H√≠brido',
                maxZoom: 20,
                overlay: false,
                control: true
            }).addTo(map);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB',
                name: 'üåô Modo oscuro',
                maxZoom: 20,
                overlay: false,
                control: true
            }).addTo(map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                name: 'üåê OpenStreetMap',
                maxZoom: 20,
                overlay: false,
                control: true
            }).addTo(map);
            
            // Agregar controles
            L.control.layers({}, {}, {
                position: 'topright',
                collapsed: true
            }).addTo(map);
            
            // Control pantalla completa
            L.control.fullscreen({
                position: 'topright',
                title: 'Pantalla completa',
                titleCancel: 'Salir pantalla completa'
            }).addTo(map);
            
            // Control de medidas
            L.control.measure({
                position: 'topright',
                primaryLengthUnit: 'kilometers',
                secondaryLengthUnit: 'meters',
                primaryAreaUnit: 'hectares',
                secondaryAreaUnit: 'sqmeters'
            }).addTo(map);
            
            console.log('‚úÖ Mapa inicializado');
        }
        
        // ============================================
        // 3. CARGAR DATOS DESDE GITHUB
        // ============================================
        async function cargarDatosDesdeGitHub() {
            console.log('üì° Cargando datos desde GitHub...');
            
            // Mostrar panel de carga
            document.getElementById('cargandoPanel').style.display = 'block';
            actualizarEstadoCarga('Conectando con GitHub...');
            
            try {
                document.getElementById('progresoCarga').textContent = 'Descargando GeoJSON...';
                
                const response = await fetch(GEOJSON_URL);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                document.getElementById('progresoCarga').textContent = 'Procesando datos...';
                const data = await response.json();
                geojsonData = data;
                
                console.log('‚úÖ Datos cargados:', data);
                
                // Guardar sesi√≥n
                localStorage.setItem('sesion_valida', 'true');
                localStorage.setItem('ultimo_acceso', new Date().toISOString());
                
                // Procesar datos
                procesarDatos(data);
                
                // Ocultar panel de carga
                document.getElementById('cargandoPanel').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                mostrarError(`Error al cargar datos: ${error.message}`);
                document.getElementById('cargandoPanel').style.display = 'none';
            }
        }
        
        // ============================================
        // 4. PROCESAR DATOS (FUNCIONES EXACTAS DE TU APP)
        // ============================================
        
        function procesarDatos(data) {
            if (!data || !data.features || data.features.length === 0) {
                mostrarError('No hay datos para mostrar');
                return;
            }
            
            // Encontrar campos autom√°ticamente
            encontrarCamposClave(data.features[0].properties);
            
            // Contar pol√≠gonos
            const numPoligonos = data.features.length;
            actualizarContadorPoligonos(numPoligonos);
            
            // Calcular estad√≠sticas
            const estadisticas = calcularEstadisticas(data);
            
            // Crear capa GeoJSON
            crearCapaGeoJSON(data);
            
            // Crear leyenda de cultivos
            crearLeyendaCultivos(estadisticas.superficiePorCultivo, estadisticas.totalSuperficie);
            
            // Crear buscador de clientes
            if (campoCliente) {
                crearBuscadorClientes(estadisticas.clientesUnicos);
            }
            
            // Crear leyenda de precipitaci√≥n
            crearLeyendaPrecipitacion();
            
            // Crear panel de gr√°ficos
            crearPanelGraficos(estadisticas.hectareasPorZona);
            
            // Actualizar fecha de √∫ltima actualizaci√≥n
            actualizarFechaActualizacion();
            
            // Agregar capas WMS (IMERG y CHIRPS)
            agregarCapasWMS();
            
            console.log('‚úÖ Datos procesados');
        }
        
        function encontrarCamposClave(propiedades) {
            // Buscar campo cliente
            const posiblesClientes = ['CLIENTE', 'cliente', 'Cliente', 'NOMBRE_CLIENTE'];
            for (const campo of posiblesClientes) {
                if (propiedades[campo] !== undefined) {
                    campoCliente = campo;
                    break;
                }
            }
            
            // Buscar campo cultivo
            const posiblesCultivos = ['CULTIVO', 'cultivo', 'Cultivo', 'CROP', 'crop'];
            for (const campo of posiblesCultivos) {
                if (propiedades[campo] !== undefined) {
                    campoCultivo = campo;
                    break;
                }
            }
            
            // Buscar campo hect√°reas
            const posiblesHectareas = ['HECTAREAS_ASEGURADAS', 'HECTAREAS_DECLARADAS', 'hectareas', 'HECTAREAS', 'HAS', 'has'];
            for (const campo of posiblesHectareas) {
                if (propiedades[campo] !== undefined) {
                    campoHectareas = campo;
                    break;
                }
            }
            
            // Buscar campo zona
            const posiblesZonas = ['ZONA_CZ4', 'ZONA', 'Zona', 'zona', 'CZ4'];
            for (const campo of posiblesZonas) {
                if (propiedades[campo] !== undefined) {
                    campoZona = campo;
                    break;
                }
            }
            
            console.log('Campos encontrados:', { campoCliente, campoCultivo, campoHectareas, campoZona });
        }
        
        function calcularEstadisticas(data) {
            const estadisticas = {
                superficiePorCultivo: {},
                totalSuperficie: 0,
                hectareasPorZona: {},
                clientesUnicos: new Set()
            };
            
            // Calcular superficie por cultivo
            if (campoCultivo && campoHectareas) {
                data.features.forEach(feature => {
                    const cultivo = feature.properties[campoCultivo];
                    const hectareas = parseFloat(feature.properties[campoHectareas]) || 0;
                    
                    if (cultivo) {
                        if (!estadisticas.superficiePorCultivo[cultivo]) {
                            estadisticas.superficiePorCultivo[cultivo] = 0;
                        }
                        estadisticas.superficiePorCultivo[cultivo] += hectareas;
                        estadisticas.totalSuperficie += hectareas;
                    }
                });
            }
            
            // Calcular hect√°reas por zona
            if (campoZona && campoHectareas) {
                data.features.forEach(feature => {
                    const zona = String(feature.properties[campoZona] || '').trim();
                    const hectareas = parseFloat(feature.properties[campoHectareas]) || 0;
                    
                    if (zona) {
                        if (!estadisticas.hectareasPorZona[zona]) {
                            estadisticas.hectareasPorZona[zona] = 0;
                        }
                        estadisticas.hectareasPorZona[zona] += hectareas;
                    }
                });
            }
            
            // Obtener clientes √∫nicos
            if (campoCliente) {
                data.features.forEach(feature => {
                    const cliente = feature.properties[campoCliente];
                    if (cliente) {
                        estadisticas.clientesUnicos.add(String(cliente).trim());
                    }
                });
            }
            
            return estadisticas;
        }
        
        function crearCapaGeoJSON(data) {
            // Funci√≥n de estilo por cultivo (EXACTA A TU APP)
            function estiloPorCultivo(feature) {
                let colorRelleno = '#9C27B0';
                let colorBorde = '#7B1FA2';
                
                if (campoCultivo && feature.properties[campoCultivo]) {
                    const cultivo = String(feature.properties[campoCultivo]).toLowerCase();
                    
                    if (cultivo.includes('soja') || cultivo.includes('soya')) {
                        colorRelleno = '#4CAF50';
                        colorBorde = '#2E7D32';
                    } else if (cultivo.includes('ma√≠z') || cultivo.includes('maiz') || cultivo.includes('corn')) {
                        colorRelleno = '#FFC107';
                        colorBorde = '#FF8F00';
                    } else if (cultivo.includes('trigo') || cultivo.includes('wheat')) {
                        colorRelleno = '#795548';
                        colorBorde = '#5D4037';
                    } else if (cultivo.includes('girasol') || cultivo.includes('sunflower')) {
                        colorRelleno = '#FF9800';
                        colorBorde = '#EF6C00';
                    } else if (cultivo.includes('algod√≥n') || cultivo.includes('algodon') || cultivo.includes('cotton')) {
                        colorRelleno = '#2196F3';
                        colorBorde = '#1976D2';
                    } else if (cultivo.includes('sorgo') || cultivo.includes('sorghum')) {
                        colorRelleno = '#E91E63';
                        colorBorde = '#C2185B';
                    }
                }
                
                // Guardar colores en propiedades (para restaurar despu√©s)
                feature.properties._color_fill = colorRelleno;
                feature.properties._color_border = colorBorde;
                
                return {
                    fillColor: colorRelleno,
                    color: colorBorde,
                    weight: 2,
                    fillOpacity: 0.6,
                    dashArray: '5, 5'
                };
            }
            
            // Funci√≥n highlight
            function highlightFeature(e) {
                const layer = e.target;
                layer.setStyle({
                    fillColor: '#FF5722',
                    color: '#D84315',
                    weight: 3,
                    fillOpacity: 0.8,
                    dashArray: '5, 5'
                });
            }
            
            function resetHighlight(e) {
                geoLayer.resetStyle(e.target);
            }
            
            // Campos para tooltip
            const camposTooltip = [];
            if (campoCliente && campoCliente in data.features[0].properties) {
                camposTooltip.push(campoCliente);
            } else if (campoCultivo && campoCultivo in data.features[0].properties) {
                camposTooltip.push(campoCultivo);
            } else {
                camposTooltip.push('excel_fila_num');
            }
            
            // Campos para popup
            const camposEspecificos = [
                'CUIT', 'CLIENTE', 'CAMPO', 'DEPARTAMENTO', 'LOCALIDAD', 'CULTIVO', 'LOTE',
                'CULTIVO_ANTERIOR', 'RENDIMIENTO_ANTERIOR', 'HECTAREAS_DECLARADAS',
                'HECTAREAS_ASEGURADAS', 'PORCENTAJE_ASEGURADO', 'ZONA_CZ4',
                'RENDIMIENTO_ASEGURADO', 'SUMA_ASEGURADA', 'FECHA_CREACION'
            ];
            
            const camposExistentes = camposEspecificos.filter(campo => 
                campo in data.features[0].properties
            );
            
            // Crear capa
            geoLayer = L.geoJSON(data, {
                style: estiloPorCultivo,
                onEachFeature: function(feature, layer) {
                    // Tooltip
                    if (camposTooltip.length > 0 && feature.properties[camposTooltip[0]]) {
                        layer.bindTooltip(feature.properties[camposTooltip[0]], {
                            sticky: true,
                            className: 'leaflet-tooltip-custom'
                        });
                    }
                    
                    // Popup
                    const popupContent = crearContenidoPopup(feature.properties);
                    layer.bindPopup(popupContent, {
                        maxWidth: 350,
                        maxHeight: 400,
                        className: 'leaflet-popup-custom'
                    });
                    
                    // Eventos
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight
                    });
                }
            }).addTo(map);
            
            // Guardar bounds
            boundsGeneral = geoLayer.getBounds();
            if (boundsGeneral.isValid()) {
                map.fitBounds(boundsGeneral);
            }
            
            // Mostrar elementos de UI
            document.getElementById('lupitaBuscador').style.display = 'block';
            document.getElementById('leyendaCultivosContainer').style.display = 'block';
            document.getElementById('leyendaPrecip').style.display = 'block';
            document.getElementById('btnGraficos').style.display = 'flex';
            
            // Agregar nombre a la capa para referencia en JavaScript
            geoLayer._nombre = 'capa_poligonos_principal';
        }
        
        function crearContenidoPopup(propiedades) {
            let contenido = '<div style="font-family: Arial; font-size: 12px; max-width: 300px;">';
            
            const camposImportantes = [
                'CUIT', 'CLIENTE', 'CAMPO', 'DEPARTAMENTO', 'LOCALIDAD', 
                'CULTIVO', 'LOTE', 'CULTIVO_ANTERIOR', 'RENDIMIENTO_ANTERIOR',
                'HECTAREAS_DECLARADAS', 'HECTAREAS_ASEGURADAS', 'PORCENTAJE_ASEGURADO',
                'ZONA_CZ4', 'RENDIMIENTO_ASEGURADO', 'SUMA_ASEGURADA', 'FECHA_CREACION'
            ];
            
            camposImportantes.forEach(campo => {
                if (propiedades[campo] !== undefined && propiedades[campo] !== null && propiedades[campo] !== '') {
                    contenido += `<div><b>${campo}:</b> ${propiedades[campo]}</div>`;
                }
            });
            
            contenido += '</div>';
            return contenido;
        }
        
        // ============================================
        // 5. FUNCIONES DE INTERFAZ (EXACTAS A TU APP)
        // ============================================
        
        function actualizarEstadoCarga(mensaje) {
            document.getElementById('estadoCarga').textContent = mensaje;
        }
        
        function actualizarContadorPoligonos(num) {
            document.getElementById('contadorPoligonos').textContent = `${num.toLocaleString()} pol√≠gonos`;
        }
        
        function actualizarFechaActualizacion() {
            const ahora = new Date();
            const fechaStr = ahora.toLocaleDateString('es-AR');
            const horaStr = ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('fechaActualizacion').textContent = `√öltima actualizaci√≥n: ${fechaStr} ${horaStr}`;
        }
        
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('mensajeError');
            errorDiv.innerHTML = `
                <h3>‚ùå Error</h3>
                <p>${mensaje}</p>
                <button onclick="cargarDatosDesdeGitHub()" style="margin-top: 10px; padding: 5px 15px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Reintentar
                </button>
            `;
            errorDiv.style.display = 'block';
        }
        
        // ============================================
        // 6. BUSCADOR DE CLIENTES (EXACTO A TU APP)
        // ============================================
        
        function crearBuscadorClientes(clientesSet) {
            if (!clientesSet || clientesSet.size === 0) {
                console.log('‚ö†Ô∏è No se encontraron clientes para el buscador');
                return;
            }
            
            const clientes = Array.from(clientesSet).sort();
            const numPoligonos = geojsonData ? geojsonData.features.length : 0;
            
            const buscadorHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #000000; font-size: 12px; display: flex; align-items: center;">
                        <span style="margin-right: 5px;">üîç</span>
                        Buscar cliente
                    </div>
                    <button id="toggleBuscador" style="background: none; border: none; cursor: pointer; font-size: 14px; color: #000000;">‚ñ≤</button>
                </div>
                
                <div id="contenidoBuscador">
                    <div style="margin-bottom: 8px;">
                        <input list="clientesList" id="clienteInput" placeholder="Escribe o selecciona..." 
                               style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                        <datalist id="clientesList">
                            ${clientes.map(cliente => `<option value="${cliente}">`).join('')}
                        </datalist>
                    </div>
                    
                    <div style="display: flex; gap: 5px; margin-bottom: 6px;">
                        <button onclick="filtrarCliente()" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                            Filtrar
                        </button>
                        <button onclick="resetearFiltro()" style="flex: 1; background-color: #f44336; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                            Reset
                        </button>
                    </div>
                    
                    <div id="estadoFiltro" style="font-size: 9px; color: #666; margin-top: 6px; padding-top: 5px; border-top: 1px solid #000000;">
                        Mostrando todos (${numPoligonos})
                    </div>
                </div>
            `;
            
            document.getElementById('lupitaBuscador').innerHTML = buscadorHTML;
            
            // Configurar toggle
            let contenidoVisible = true;
            document.getElementById('toggleBuscador').addEventListener('click', function() {
                const contenido = document.getElementById('contenidoBuscador');
                const lupita = document.getElementById('lupitaBuscador');
                
                if (contenidoVisible) {
                    contenido.style.display = 'none';
                    this.innerHTML = '‚ñº';
                    lupita.style.width = '150px';
                    lupita.style.padding = '5px 8px';
                } else {
                    contenido.style.display = 'block';
                    this.innerHTML = '‚ñ≤';
                    lupita.style.width = '220px';
                    lupita.style.padding = '8px 10px';
                }
                contenidoVisible = !contenidoVisible;
            });
            
            // Permitir Enter para filtrar
            document.getElementById('clienteInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filtrarCliente();
                }
            });
        }
        
        // Funci√≥n de filtrado
        window.filtrarCliente = function() {
            const valor = document.getElementById('clienteInput').value.toLowerCase();
            if (!valor) {
                alert('Por favor, escribe o selecciona un cliente');
                return;
            }
            
            let boundsFiltrados = null;
            let contador = 0;
            
            // Almacenar estilos originales
            geoLayer.eachLayer(function(layer) {
                if (!layer._estiloOriginal) {
                    layer._estiloOriginal = {
                        fillColor: layer.options.fillColor,
                        color: layer.options.color,
                        weight: layer.options.weight,
                        fillOpacity: layer.options.fillOpacity,
                        opacity: layer.options.opacity,
                        interactive: layer.options.interactive
                    };
                }
            });
            
            // Filtrar
            geoLayer.eachLayer(function(layer) {
                const propiedades = layer.feature.properties;
                const clienteEnPoligono = propiedades[campoCliente];
                
                if (clienteEnPoligono && clienteEnPoligono.toString().toLowerCase().includes(valor)) {
                    // MOSTRAR
                    layer.setStyle({
                        fillOpacity: 0.6,
                        weight: 2,
                        opacity: 1,
                        fillColor: layer._estiloOriginal.fillColor,
                        color: layer._estiloOriginal.color
                    });
                    layer.options.interactive = true;
                    
                    // Agregar a bounds
                    const layerBounds = layer.getBounds();
                    if (layerBounds) {
                        boundsFiltrados = boundsFiltrados ? boundsFiltrados.extend(layerBounds) : layerBounds;
                    }
                    contador++;
                } else {
                    // OCULTAR COMPLETAMENTE
                    layer.setStyle({
                        fillOpacity: 0,
                        weight: 0,
                        opacity: 0
                    });
                    layer.options.interactive = false;
                }
            });
            
            // Actualizar estado
            const estadoDiv = document.getElementById('estadoFiltro');
            if (estadoDiv) {
                if (contador > 0) {
                    estadoDiv.innerHTML = `Mostrando ${contador} pol√≠gonos`;
                    estadoDiv.style.color = '#4CAF50';
                    
                    // Zoom a los filtrados
                    if (boundsFiltrados) {
                        map.fitBounds(boundsFiltrados, { padding: [50, 50] });
                    }
                } else {
                    estadoDiv.innerHTML = '‚ùå No se encontraron';
                    estadoDiv.style.color = '#f44336';
                }
            }
        };
        
        // Funci√≥n reset
        window.resetearFiltro = function() {
            document.getElementById('clienteInput').value = '';
            
            // Restaurar TODOS los pol√≠gonos
            geoLayer.eachLayer(function(layer) {
                if (layer._estiloOriginal) {
                    layer.setStyle(layer._estiloOriginal);
                    layer.options.interactive = true;
                }
            });
            
            // Restaurar zoom original
            if (boundsGeneral && boundsGeneral.isValid()) {
                map.fitBounds(boundsGeneral);
            }
            
            // Actualizar estado
            const estadoDiv = document.getElementById('estadoFiltro');
            if (estadoDiv) {
                estadoDiv.innerHTML = `Mostrando todos (${geojsonData.features.length})`;
                estadoDiv.style.color = '#666';
            }
        };
        
        // ============================================
        // 7. LEYENDA DE CULTIVOS (EXACTA A TU APP)
        // ============================================
        
        function crearLeyendaCultivos(superficiePorCultivo, totalSuperficie) {
            if (!superficiePorCultivo || Object.keys(superficiePorCultivo).length === 0) {
                return;
            }
            
            const numCultivos = Object.keys(superficiePorCultivo).length;
            let contenido = `
                <div style="font-weight: bold; color: #2E7D32; margin-bottom: 6px; 
                            font-size: 11px; border-bottom: 1px solid #ddd; padding-bottom: 3px;">
                    Cultivos (${numCultivos})
                </div>
            `;
            
            // Ordenar por superficie y tomar top 8
            const cultivosOrdenados = Object.entries(superficiePorCultivo)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            cultivosOrdenados.forEach(([cultivo, hectareas]) => {
                const porcentaje = totalSuperficie > 0 ? (hectareas / totalSuperficie * 100) : 0;
                const color = obtenerColorPorCultivo(cultivo);
                const nombreCorto = cultivo.length > 15 ? cultivo.substring(0, 15) + '...' : cultivo;
                
                contenido += `
                    <div style="display: flex; align-items: center; margin-bottom: 3px;">
                        <div class="color-box" style="background-color: ${color};"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 10px; font-weight: bold;">${nombreCorto}</span>
                            <span style="font-size: 9px; color: #666; margin-left: 5px;">${hectareas.toFixed(0)}ha (${porcentaje.toFixed(0)}%)</span>
                        </div>
                    </div>
                `;
            });
            
            contenido += `
                <div style="margin-top: 6px; padding-top: 4px; border-top: 1px solid #4CAF50; 
                            font-size: 10px; font-weight: bold; color: #2E7D32; text-align: center;">
                    TOTAL: ${totalSuperficie.toFixed(0)} ha
                </div>
            `;
            
            document.getElementById('leyendaCultivosContainer').innerHTML = contenido;
        }
        
        function obtenerColorPorCultivo(cultivo) {
            if (!cultivo) return '#9C27B0';
            
            const cultivoLower = String(cultivo).toLowerCase();
            
            if (cultivoLower.includes('soja') || cultivoLower.includes('soya')) {
                return '#4CAF50';
            } else if (cultivoLower.includes('ma√≠z') || cultivoLower.includes('maiz') || cultivoLower.includes('corn')) {
                return '#FFC107';
            } else if (cultivoLower.includes('trigo') || cultivoLower.includes('wheat')) {
                return '#795548';
            } else if (cultivoLower.includes('girasol') || cultivoLower.includes('sunflower')) {
                return '#FF9800';
            } else if (cultivoLower.includes('algod√≥n') || cultivoLower.includes('algodon') || cultivoLower.includes('cotton')) {
                return '#2196F3';
            } else if (cultivoLower.includes('sorgo') || cultivoLower.includes('sorghum')) {
                return '#E91E63';
            } else {
                return '#9C27B0';
            }
        }
        
        // ============================================
        // 8. LEYENDA DE PRECIPITACI√ìN (EXACTA A TU APP)
        // ============================================
        
        function crearLeyendaPrecipitacion() {
            const leyendaHTML = `
                <div style="font-weight: bold; color: #1E88E5; 
                            margin-bottom: 10px; border-bottom: 2px solid #1E88E5; 
                            padding-bottom: 6px; font-size: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span>üåßÔ∏è</span>
                            <span>Precipitaci√≥n (mm)</span>
                        </div>
                        <button onclick="ocultarLeyendaPrecip()" 
                                style="background: none; border: none; color: #1E88E5; 
                                       font-size: 16px; cursor: pointer; padding: 0; 
                                       line-height: 1;">√ó</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #9e9eFF; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">0</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">2</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #0000FF; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">2</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">5</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #00FFFF; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">5</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">10</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #00FF80; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">10</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">15</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #00FF00; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">15</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">20</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #FFFF00; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">20</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">30</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #FFA500; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">30</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">50</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <div style="width: 18px; height: 18px; background-color: #FF4500; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px;">50</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px;">100</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <div style="width: 18px; height: 18px; background-color: #FF0000; 
                                    margin-right: 10px; border: 1px solid #666; border-radius: 3px;"></div>
                        <div style="flex: 1; display: flex; justify-content: space-between;">
                            <span style="font-size: 10px; font-weight: bold;">> 100</span>
                            <span style="font-size: 10px; color: #666;">mm</span>
                            <span style="font-size: 10px; font-weight: bold;"></span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('leyendaPrecip').innerHTML = leyendaHTML;
        }
        
        window.ocultarLeyendaPrecip = function() {
            document.getElementById('leyendaPrecip').style.display = 'none';
        };
        
        // ============================================
        // 9. PANEL DE GR√ÅFICOS (EXACTO A TU APP)
        // ============================================
        
        function crearPanelGraficos(hectareasPorZona) {
            const zonasOrdenadas = ["1", "2", "3", "4"];
            
            let datosProyectados = [];
            let datosReales = [];
            let diferencias = [];
            let porcentajesDif = [];
            
            // Preparar datos
            zonasOrdenadas.forEach(zona => {
                const proyectado = HECTAREAS_PROYECTADAS[zona] || 0;
                const real = hectareasPorZona[zona] || 0;
                const diferencia = real - proyectado;
                const porcentaje = proyectado > 0 ? (diferencia / proyectado * 100) : 0;
                
                datosProyectados.push(proyectado);
                datosReales.push(real);
                diferencias.push(diferencia);
                porcentajesDif.push(porcentaje);
            });
            
            const maxValor = Math.max(...datosProyectados, ...datosReales) || 100000;
            const totalProyectado = datosProyectados.reduce((a, b) => a + b, 0);
            const totalReal = datosReales.reduce((a, b) => a + b, 0);
            const totalDiferencia = totalReal - totalProyectado;
            const totalPorcentaje = totalProyectado > 0 ? (totalDiferencia / totalProyectado * 100) : 0;
            
            // Generar HTML para gr√°ficos
            let barrasHTML = '';
            let tablaHTML = '';
            
            zonasOrdenadas.forEach((zona, i) => {
                const proyectado = datosProyectados[i];
                const real = datosReales[i];
                const diferencia = diferencias[i];
                const porcentaje = porcentajesDif[i];
                
                const anchoProyectado = Math.min(95, (proyectado / maxValor * 95));
                const anchoReal = Math.min(95, (real / maxValor * 95));
                const colorReal = diferencia >= 0 ? '#2196F3' : '#f44336';
                const colorDiferencia = diferencia >= 0 ? '#4CAF50' : '#f44336';
                const iconoDiferencia = diferencia >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
                
                // Gr√°fico de barras
                barrasHTML += `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-weight: bold; color: #333; font-size: 14px;">ZONA ${zona}</div>
                            <div style="font-size: 13px; color: #666;">
                                Diferencia: <span style="font-weight: bold; color: ${colorDiferencia}">
                                    ${diferencia.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha (${porcentaje.toFixed(1)}%) ${iconoDiferencia}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 12px; color: #666;">Proyectado</span>
                                <span style="font-size: 12px; font-weight: bold; color: #2E7D32">${proyectado.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha</span>
                            </div>
                            <div style="width: 100%; background-color: #f0f0f0; border-radius: 4px; height: 24px; overflow: hidden;">
                                <div style="width: ${anchoProyectado}%; height: 100%; background-color: #2E7D32; border-radius: 4px; display: flex; align-items: center; padding-left: 10px;">
                                    <span style="color: white; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">PROYECTADO</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 12px; color: #666;">Actual</span>
                                <span style="font-size: 12px; font-weight: bold; color: ${colorReal}">${real.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha</span>
                            </div>
                            <div style="width: 100%; background-color: #f0f0f0; border-radius: 4px; height: 24px; overflow: hidden;">
                                <div style="width: ${anchoReal}%; height: 100%; background-color: ${colorReal}; border-radius: 4px; display: flex; align-items: center; padding-left: 10px;">
                                    <span style="color: white; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">ACTUAL</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Tabla
                tablaHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: bold;">Zona ${zona}</td>
                        <td style="padding: 10px; text-align: right;">${proyectado.toLocaleString('es-AR', { maximumFractionDigits: 0 })}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;">${real.toLocaleString('es-AR', { maximumFractionDigits: 0 })}</td>
                        <td style="padding: 10px; text-align: right; color: ${colorDiferencia}; font-weight: bold;">
                            ${diferencia > 0 ? '+' : ''}${diferencia.toLocaleString('es-AR', { maximumFractionDigits: 0 })}
                        </td>
                        <td style="padding: 10px; text-align: right; color: ${colorDiferencia};">
                            ${porcentaje > 0 ? '+' : ''}${porcentaje.toFixed(1)}%
                        </td>
                    </tr>
                `;
            });
            
            // HTML completo del panel
            const panelHTML = `
                <div style="position: sticky; top: 0; background-color: #2E7D32; color: white; padding: 15px 20px; border-top-left-radius: 15px; border-top-right-radius: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 1;">
                    <div style="font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                        <span>üìä</span>
                        COMPARACI√ìN POR ZONA - PROYECTADO vs ACTUAL
                    </div>
                    <button onclick="togglePanelGraficos()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
                </div>
                
                <div style="padding: 20px; max-width: 1000px; margin: 0 auto;">
                    <!-- RESUMEN -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2E7D32;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">TOTAL PROYECTADO</div>
                            <div style="font-size: 22px; font-weight: bold; color: #2E7D32;">${totalProyectado.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha</div>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">TOTAL ACTUAL</div>
                            <div style="font-size: 22px; font-weight: bold; color: #2196F3;">${totalReal.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha</div>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">DIFERENCIA TOTAL</div>
                            <div style="font-size: 22px; font-weight: bold; color: ${totalDiferencia >= 0 ? '#4CAF50' : '#f44336'};">${totalDiferencia > 0 ? '+' : ''}${totalDiferencia.toLocaleString('es-AR', { maximumFractionDigits: 0 })} ha</div>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">% DE CUMPLIMIENTO</div>
                            <div style="font-size: 22px; font-weight: bold; color: ${totalPorcentaje >= 0 ? '#4CAF50' : '#f44336'};">${totalPorcentaje.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- GR√ÅFICO DE BARRAS -->
                    <div style="background-color: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333; font-size: 16px; border-bottom: 2px solid #2E7D32; padding-bottom: 8px;">HECT√ÅREAS POR ZONA - COMPARACI√ìN</h3>
                        <div style="display: flex; flex-direction: column; gap: 20px;">${barrasHTML}</div>
                    </div>
                    
                    <!-- TABLA RESUMEN -->
                    <div style="background-color: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333; font-size: 16px;">RESUMEN</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #2E7D32;">ZONA</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2E7D32;">PROYECTADO (ha)</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2E7D32;">ACTUAL (ha)</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2E7D32;">DIFERENCIA (ha)</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #2E7D32;">% VARIACI√ìN</th>
                                    </tr>
                                </thead>
                                <tbody>${tablaHTML}</tbody>
                                <tfoot style="background-color: #f9f9f9; font-weight: bold;">
                                    <tr>
                                        <td style="padding: 10px; border-top: 2px solid #2E7D32;">TOTAL</td>
                                        <td style="padding: 10px; text-align: right; border-top: 2px solid #2E7D32;">${totalProyectado.toLocaleString('es-AR', { maximumFractionDigits: 0 })}</td>
                                        <td style="padding: 10px; text-align: right; border-top: 2px solid #2E7D32;">${totalReal.toLocaleString('es-AR', { maximumFractionDigits: 0 })}</td>
                                        <td style="padding: 10px; text-align: right; border-top: 2px solid #2E7D32; color: ${totalDiferencia >= 0 ? '#4CAF50' : '#f44336'};">${totalDiferencia > 0 ? '+' : ''}${totalDiferencia.toLocaleString('es-AR', { maximumFractionDigits: 0 })}</td>
                                        <td style="padding: 10px; text-align: right; border-top: 2px solid #2E7D32; color: ${totalPorcentaje >= 0 ? '#4CAF50' : '#f44336'};">${totalPorcentaje > 0 ? '+' : ''}${totalPorcentaje.toFixed(1)}%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- INFORMACI√ìN -->
                    <div style="font-size: 12px; color: #666; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #FF9800;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span>üí°</span>
                            <strong>Informaci√≥n para el an√°lisis:</strong>
                        </div>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Datos proyectados: valores estimados para la campa√±a 25/26</li>
                            <li>Datos actuales: calculados autom√°ticamente del archivo GeoJSON cargado</li>
                            <li>Verde (‚Üë): la zona supera la proyecci√≥n</li>
                            <li>Rojo (‚Üì): la zona est√° por debajo de la proyecci√≥n</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('panelGraficos').innerHTML = panelHTML;
        }
        
        window.togglePanelGraficos = function() {
            const panel = document.getElementById('panelGraficos');
            const btn = document.getElementById('btnGraficos');
            
            if (panelGraficosAbierto) {
                panel.style.bottom = '-85%';
                panel.style.zIndex = '9998';
                btn.innerHTML = 'üìä';
                btn.style.backgroundColor = '#2E7D32';
            } else {
                panel.style.zIndex = '10001';
                panel.style.bottom = '0';
                panel.style.display = 'block';
                btn.innerHTML = 'üìà';
                btn.style.backgroundColor = '#2196F3';
            }
            panelGraficosAbierto = !panelGraficosAbierto;
        };
        
        // ============================================
        // 10. CAPAS WMS (IMERG Y CHIRPS)
        // ============================================
        
        function agregarCapasWMS() {
            // IMERG Diario
            const imergUrl = "https://geoservicios2.conae.gov.ar/geoserver/PrecipitacionAcumulada/wms";
            
            // Capas IMERG (simuladas - en realidad necesitar√≠as consultar el WMS)
            const capasImerg = [
                { nombre: 'MOM_GPMIMERG_PA1D_1', display: 'üåßÔ∏è PP Hoy' },
                { nombre: 'MOM_GPMIMERG_PA1D_2', display: 'üåßÔ∏è PP Ayer' },
                { nombre: 'MOM_GPMIMERG_PA1D_3', display: 'üåßÔ∏è PP Anteayer' }
            ];
            
            capasImerg.forEach((capa, i) => {
                const opacidad = [0.7, 0.6, 0.5][i] || 0.5;
                
                try {
                    const wmsLayer = L.tileLayer.wms(imergUrl, {
                        layers: capa.nombre,
                        format: 'image/png',
                        transparent: true,
                        opacity: opacidad,
                        attribution: 'CONAE IMERG'
                    });
                    
                    // Agregar al control de capas
                    wmsLayer.addTo(map);
                    console.log(`‚úÖ Capa IMERG agregada: ${capa.display}`);
                } catch (error) {
                    console.log(`‚ö†Ô∏è No se pudo agregar capa IMERG: ${capa.display}`);
                }
            });
            
            // CHIRPS Mensual
            const chirpsUrl = "https://geoservicios2.conae.gov.ar/geoserver/wms";
            const capasChirps = [
                { nombre: 'PrecipitacionAcumulada:MOM_CHIRPS_PA1M_1', display: 'üìÖ PP Mes Actual' },
                { nombre: 'PrecipitacionAcumulada:MOM_CHIRPS_PA1M_2', display: 'üìÖ PP Mes Anterior' }
            ];
            
            capasChirps.forEach((capa, i) => {
                const opacidad = [0.5, 0.4][i] || 0.4;
                
                try {
                    const wmsLayer = L.tileLayer.wms(chirpsUrl, {
                        layers: capa.nombre,
                        format: 'image/png',
                        transparent: true,
                        opacity: opacidad,
                        attribution: 'CONAE CHIRPS'
                    });
                    
                    wmsLayer.addTo(map);
                    console.log(`‚úÖ Capa CHIRPS agregada: ${capa.display}`);
                } catch (error) {
                    console.log(`‚ö†Ô∏è No se pudo agregar capa CHIRPS: ${capa.display}`);
                }
            });
        }
        
        // ============================================
        // 11. INICIALIZAR APLICACI√ìN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            
            // Configurar eventos de login
            document.getElementById('loginButton').addEventListener('click', verificarLogin);
            
            document.getElementById('loginUsuario').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginContrasena').focus();
                }
            });
            
            document.getElementById('loginContrasena').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarLogin();
                }
            });
            
            // Verificar sesi√≥n activa
            if (!verificarSesionActiva()) {
                // Enfocar usuario input
                setTimeout(() => {
                    document.getElementById('loginUsuario').focus();
                }, 500);
            }
        });
        
    </script>
    
</body>
</html>
