<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROGRAMA C√ìRDOBA 25/26 - Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos b√°sicos - Mant√©n tus estilos actuales */
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 100vh; }
        
        /* T√≠tulo (igual que tu c√≥digo) */
        .map-title {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #4CAF50;
            z-index: 9999;
            font-family: Arial, sans-serif;
            font-size: 10px;
            max-width: 200px;
            min-width: 180px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Bot√≥n de actualizaci√≥n */
        .update-button {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 9999;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .update-button:hover {
            background-color: #1976D2;
        }
        
        /* Info de √∫ltima actualizaci√≥n */
        .update-info {
            position: fixed;
            top: 50px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            z-index: 9999;
            font-size: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- T√≠tulo -->
    <div class="map-title">
        <div style="font-weight: bold; color: #2E7D32; font-size: 14px; margin-bottom: 4px;">
            PROGRAMA C√ìRDOBA 25/26
        </div>
        <div style="margin-top: 4px; font-size: 9px; color: #555; border-top: 1px solid #e0e0e0; padding-top: 4px;">
            <div><b>√öltima actualizaci√≥n:</b> <span id="lastUpdate">Cargando...</span></div>
            <div><b>Pol√≠gonos:</b> <span id="polygonCount">0</span></div>
        </div>
    </div>
    
    <!-- Bot√≥n de actualizaci√≥n -->
    <button class="update-button" onclick="checkForUpdates()">
        <i class="fas fa-sync-alt"></i> Verificar actualizaci√≥n
    </button>
    
    <!-- Info actualizaci√≥n -->
    <div class="update-info" id="updateInfo" style="display: none;">
        <span id="updateMessage"></span>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- INCLUYE AQU√ç TODOS TUS SCRIPTS DE MAPA, CAPAS, BUSCADOR, etc. -->
    <!-- (Todo el JavaScript de tu c√≥digo 3, excepto la parte de login en Colab) -->
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variable global para el mapa
        let map;
        let geoJsonLayer;
        
        // URL del GeoJSON actualizado
        const GEOJSON_URL = 'https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/data/latest.geojson';
        const UPDATE_CHECK_URL = 'https://api.github.com/repos/TU_USUARIO/TU_REPO/commits?path=data/latest.geojson&per_page=1';
        
        // Inicializar mapa
        function initMap() {
            // Configuraci√≥n inicial del mapa (igual que tu c√≥digo)
            map = L.map('map', {
                center: [-31.4201, -64.1888],
                zoom: 11,
                zoomControl: true
            });
            
            // Agregar capas base (igual que tu c√≥digo)
            L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                name: 'üåç Google Sat√©lite',
                maxZoom: 20
            }).addTo(map);
            
            // ... otras capas base
            
            // Cargar GeoJSON
            loadGeoJSON();
            
            // Verificar √∫ltima actualizaci√≥n
            checkLastUpdate();
        }
        
        // Cargar GeoJSON
        function loadGeoJSON() {
            // Remover capa anterior si existe
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }
            
            // Cargar GeoJSON
            fetch(GEOJSON_URL)
                .then(response => {
                    if (!response.ok) throw new Error('Error cargando GeoJSON');
                    return response.json();
                })
                .then(data => {
                    // Procesar datos (igual que tu c√≥digo)
                    updatePolygonCount(data);
                    
                    // Crear capa GeoJSON con tus estilos y funciones
                    geoJsonLayer = L.geoJSON(data, {
                        style: function(feature) {
                            // Tu funci√≥n de estilo por cultivo
                            return {
                                fillColor: getColorByCrop(feature.properties.CULTIVO),
                                color: '#7B1FA2',
                                weight: 2,
                                fillOpacity: 0.6,
                                dashArray: '5, 5'
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            // Tooltips y popups (igual que tu c√≥digo)
                            if (feature.properties && feature.properties.CLIENTE) {
                                layer.bindTooltip(feature.properties.CLIENTE);
                                layer.bindPopup(createPopupContent(feature.properties));
                            }
                        }
                    }).addTo(map);
                    
                    // Ajustar vista
                    if (data.features && data.features.length > 0) {
                        map.fitBounds(geoJsonLayer.getBounds());
                    }
                    
                    console.log('‚úÖ GeoJSON cargado:', data.features.length, 'pol√≠gonos');
                })
                .catch(error => {
                    console.error('‚ùå Error cargando GeoJSON:', error);
                    document.getElementById('polygonCount').textContent = 'Error';
                });
        }
        
        // Verificar √∫ltima actualizaci√≥n
        function checkLastUpdate() {
            fetch(UPDATE_CHECK_URL)
                .then(response => response.json())
                .then(data => {
                    if (data && data[0] && data[0].commit) {
                        const lastCommit = new Date(data[0].commit.committer.date);
                        document.getElementById('lastUpdate').textContent = 
                            lastCommit.toLocaleDateString('es-AR') + ' ' + 
                            lastCommit.toLocaleTimeString('es-AR');
                    }
                })
                .catch(error => {
                    console.error('Error verificando actualizaci√≥n:', error);
                });
        }
        
        // Verificar actualizaciones manualmente
        function checkForUpdates() {
            const updateBtn = document.querySelector('.update-button');
            const updateInfo = document.getElementById('updateInfo');
            const updateMessage = document.getElementById('updateMessage');
            
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            updateBtn.disabled = true;
            
            // Forzar recarga del GeoJSON
            loadGeoJSON();
            
            // Mostrar mensaje
            updateInfo.style.display = 'block';
            updateMessage.textContent = 'Datos actualizados';
            updateMessage.style.color = '#4CAF50';
            
            setTimeout(() => {
                updateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Verificar actualizaci√≥n';
                updateBtn.disabled = false;
                setTimeout(() => {
                    updateInfo.style.display = 'none';
                }, 3000);
            }, 1000);
        }
        
        // Funci√≥n auxiliar para contar pol√≠gonos
        function updatePolygonCount(data) {
            const count = data.features ? data.features.length : 0;
            document.getElementById('polygonCount').textContent = count;
        }
        
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
    
    <!-- INCLUYE AQU√ç EL RESTO DE TU JAVASCRIPT -->
    <!-- (Buscador, gr√°ficos, leyenda, etc. - TODO excepto login Colab) -->
</body>
</html>
