name: ğŸ¤– Actualizar datos automÃ¡ticamente

# CUÃNDO SE EJECUTA:
on:
  # 1. Manualmente desde la pestaÃ±a Actions
  workflow_dispatch:
  # 2. Cada dÃ­a a las 8 AM (hora Argentina)
  schedule:
    - cron: '0 11 * * *'  # 11 AM UTC = 8 AM Argentina
  # 3. Cuando haces cambios en los scripts
  push:
    paths:
      - 'scripts/**'
      - 'convertir_excel_a_geojson.py'
      - 'requirements.txt'
      - '.github/workflows/**'

# PERMISOS PARA HACER PUSH
permissions:
  contents: write

jobs:
  actualizar:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Descargar el cÃ³digo del repositorio
    - name: ğŸ“¥ Obtener cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Descargar todo el historial (necesario para git push)
        token: ${{ secrets.GITHUB_TOKEN }}
      
    # PASO 2: Configurar Python
    - name: ğŸ Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # PASO 3: Instalar dependencias del sistema (CHROME PRIMERO)
    - name: ğŸ–¥ï¸ Instalar Chrome y dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip chromium-browser
        echo "âœ… Dependencias del sistema instaladas"
        
    # PASO 4: Instalar dependencias de Python
    - name: ğŸ“¦ Instalar Python packages
      run: |
        echo "ğŸ“‹ Contenido de requirements.txt:"
        cat requirements.txt
        echo ""
        
        pip install --upgrade pip
        pip install -r requirements.txt
        
        echo "âœ… Paquetes Python instalados"
        echo "ğŸ“Š Versiones instaladas:"
        pip list | grep -E "(selenium|pandas|geopandas|shapely|webdriver)"
        
    # PASO 5: Descargar CSV automÃ¡ticamente
    - name: ğŸ¤– Descargar CSV de multiriesgo-cba.com
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: |
        echo "ğŸ” Usuario: $MULTIRIESGO_USUARIO"
        echo "ğŸ“‚ Directorio actual: $(pwd)"
        echo "ğŸ“‹ Archivos antes de descargar:"
        ls -la
        
        echo ""
        echo "ğŸš€ Iniciando descarga automÃ¡tica..."
        python scripts/descargar_csv.py
        
        echo ""
        echo "ğŸ“ Archivos despuÃ©s de descargar:"
        ls -la *.csv 2>/dev/null || echo "No hay archivos CSV"
        
    # PASO 6: Convertir CSV a GeoJSON
    - name: ğŸ—ºï¸ Convertir a GeoJSON
      run: |
        echo "ğŸ”„ Verificando archivo CSV..."
        if [ -f "datos_actualizados.csv" ]; then
          echo "âœ… CSV encontrado, tamaÃ±o: $(du -h datos_actualizados.csv | cut -f1)"
          echo "ğŸ”„ Convirtiendo CSV a GeoJSON..."
          python convertir_excel_a_geojson.py
        else
          echo "âŒ ERROR: No se encontrÃ³ datos_actualizados.csv"
          echo "ğŸ“ Archivos disponibles:"
          ls -la
          exit 1
        fi
        
    # PASO 7: Verificar que se crearon los archivos
    - name: ğŸ” Verificar archivos generados
      run: |
        echo "ğŸ“ ARCHIVOS GENERADOS:"
        echo "======================"
        
        # Listar todos los archivos relevantes
        find . -name "*.geojson" -o -name "*.csv" -o -name "*.json" | head -20
        
        echo ""
        echo "ğŸ“ TAMAÃ‘OS DE ARCHIVOS:"
        echo "======================"
        
        if [ -f "datos_actualizados.geojson" ]; then
          echo "âœ… datos_actualizados.geojson: $(du -h datos_actualizados.geojson | cut -f1)"
          # Contar features
          echo "   PolÃ­gonos: $(grep -c '"type": "Feature"' datos_actualizados.geojson || echo "0")"
        else
          echo "âŒ No se encontrÃ³ datos_actualizados.geojson"
        fi
        
        if [ -f "datos_actualizados.csv" ]; then
          echo "âœ… datos_actualizados.csv: $(du -h datos_actualizados.csv | cut -f1)"
          echo "   LÃ­neas: $(wc -l < datos_actualizados.csv || echo "0")"
        fi
        
    # PASO 8: Actualizar el repositorio con los nuevos datos
    - name: ğŸ’¾ Guardar cambios en GitHub
      run: |
        echo "ğŸ”„ Configurando Git..."
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "ğŸ“‹ Estado de Git antes:"
        git status --short
        
        echo ""
        echo "ğŸ“¦ Agregando archivos..."
        # Agregar archivos principales
        git add datos_actualizados.csv datos_actualizados.geojson || true
        
        # Agregar archivos de backup (si existen)
        git add poligonos_*.geojson poligonos_*.gpkg reporte_*.csv 2>/dev/null || true
        
        echo "ğŸ“‹ Estado de Git despuÃ©s de agregar:"
        git status --short
        
        echo ""
        echo "ğŸ’¾ Creando commit..."
        # Solo hacer commit si hay cambios
        if git diff --cached --quiet; then
          echo "ğŸ“­ No hay cambios para commitear"
        else
          FECHA=$(date +'%d/%m/%Y %H:%M')
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica $FECHA"
          
          echo "ğŸš€ Subiendo cambios..."
          git push
          echo "âœ… Cambios subidos a GitHub"
        fi
        
    # PASO 9: Mostrar resumen y URL
    - name: ğŸ“Š Resumen del proceso
      run: |
        echo ""
        echo "========================================"
        echo "ğŸ‰ PROCESO COMPLETADO EXITOSAMENTE"
        echo "========================================"
        echo ""
        echo "ğŸŒ DATOS DISPONIBLES EN:"
        echo "https://raw.githubusercontent.com/franciscotomatis/APP-C-rdoba/main/datos_actualizados.geojson"
        echo ""
        echo "ğŸ“ ARCHIVOS PRINCIPALES:"
        echo "- datos_actualizados.csv (datos brutos)"
        echo "- datos_actualizados.geojson (para la app)"
        echo ""
        echo "â° PRÃ“XIMA ACTUALIZACIÃ“N AUTOMÃTICA:"
        echo "- MaÃ±ana a las 8 AM (hora Argentina)"
        echo "- O haz clic en 'Run workflow' para actualizar ahora"
        echo ""
        echo "ğŸ”— ENLACE A LA APP (cuando la configures):"
        echo "https://franciscotomatis.github.io/APP-C-rdoba/"
        echo "========================================"
