name: ü§ñ Actualizar datos autom√°ticamente

on:
  schedule:
    - cron: '0 11 * * *'  # 8 AM Argentina (GMT-3) = 11 AM UTC
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          pip install pandas geopandas selenium webdriver-manager requests
      
      # üü¢ MODIFICADO: Agregar variables de entorno
      - name: Ejecutar script de descarga
        env:
          MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
          MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
        run: python scripts/descargar_csv.py
      
      - name: Verificar archivo CSV
        run: |
          echo "üìä Verificando CSV..."
          ls -lh datos_agricolas.csv
          echo "‚úÖ CSV verificado"
      
      - name: Convertir CSV a GeoJSON
        run: |
          python -c "
          import pandas as pd
          import geopandas as gpd
          from shapely import wkt
          
          print('üìñ Leyendo CSV...')
          df = pd.read_csv('datos_agricolas.csv', encoding='utf-8')
          print(f'‚úÖ CSV cargado: {len(df)} registros')
          
          # Convertir geometr√≠a WKT a shapely
          print('üîÑ Convirtiendo geometr√≠as...')
          df['geometry'] = df['WKT'].apply(wkt.loads)
          gdf = gpd.GeoDataFrame(df, geometry='geometry', crs='EPSG:4326')
          
          # Guardar como GeoJSON
          print('üíæ Guardando GeoJSON...')
          gdf.to_file('datos_actualizados.geojson', driver='GeoJSON')
          print(f'‚úÖ GeoJSON guardado: {len(gdf)} features')
          "
      
      - name: Verificar GeoJSON generado
        run: |
          echo "üìä Verificando GeoJSON..."
          ls -lh datos_actualizados.geojson
          echo "‚úÖ GeoJSON verificado"
      
      - name: Inyectar credenciales en HTML
        run: |
          echo "üîê Inyectando credenciales en index.html..."
          
          if [ ! -f "index.html" ]; then
            echo "‚ùå ERROR: index.html no encontrado"
            exit 1
          fi
          
          sed -i "s/const APP_USERNAME = \".*\"/const APP_USERNAME = \"${{ secrets.MULTIRIESGO_USUARIO }}\"/g" index.html
          sed -i "s/const APP_PASSWORD = \".*\"/const APP_PASSWORD = \"${{ secrets.MULTIRIESGO_CONTRASENA }}\"/g" index.html
          
          echo "‚úÖ Credenciales inyectadas:"
          echo "   Usuario: ${{ secrets.MULTIRIESGO_USUARIO }}"
          echo "   Contrase√±a: [PROTEGIDA]"
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add datos_actualizados.geojson index.html
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica de datos - $(date '+%Y-%m-%d %H:%M')"
          git push
      
      - name: Resumen final
        run: |
          echo "üéâ PROCESO COMPLETADO EXITOSAMENTE"
          echo "üìÖ √öltima actualizaci√≥n: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üåê App disponible en: https://franciscotomatis.github.io/APP-C-rdoba/"
