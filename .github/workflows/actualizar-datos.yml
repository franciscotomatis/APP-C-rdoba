name: ğŸ¤– Actualizar datos automÃ¡ticamente

on:
  schedule:
    - cron: '0 11 * * *'  # 8 AM Argentina (GMT-3) = 11 AM UTC
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          pip install pandas geopandas selenium webdriver-manager requests
      
      - name: Ejecutar script de descarga
        run: python scripts/descargar_csv.py
      
      - name: Verificar archivo CSV
        run: |
          echo "ğŸ“Š Verificando CSV..."
          ls -lh datos_agricolas.csv
          echo "âœ… CSV verificado"
      
      - name: Convertir CSV a GeoJSON
        run: |
          python -c "
          import pandas as pd
          import geopandas as gpd
          from shapely import wkt
          
          print('ğŸ“– Leyendo CSV...')
          df = pd.read_csv('datos_agricolas.csv', encoding='utf-8')
          print(f'âœ… CSV cargado: {len(df)} registros')
          
          # Convertir geometrÃ­a WKT a shapely
          print('ğŸ”„ Convirtiendo geometrÃ­as...')
          df['geometry'] = df['WKT'].apply(wkt.loads)
          gdf = gpd.GeoDataFrame(df, geometry='geometry', crs='EPSG:4326')
          
          # Guardar como GeoJSON
          print('ğŸ’¾ Guardando GeoJSON...')
          gdf.to_file('datos_actualizados.geojson', driver='GeoJSON')
          print(f'âœ… GeoJSON guardado: {len(gdf)} features')
          "
      
      - name: Verificar GeoJSON generado
        run: |
          echo "ğŸ“Š Verificando GeoJSON..."
          ls -lh datos_actualizados.geojson
          echo "âœ… GeoJSON verificado"
      
      # ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ NUEVO PASO - PEGA AQUÃ ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢
      - name: Inyectar credenciales en HTML
        run: |
          echo "ğŸ” Inyectando credenciales en index.html..."
          
          if [ ! -f "index.html" ]; then
            echo "âŒ ERROR: index.html no encontrado"
            exit 1
          fi
          
          sed -i "s/const APP_USERNAME = \".*\"/const APP_USERNAME = \"${{ secrets.MULTIRIESGO_USUARIO }}\"/g" index.html
          sed -i "s/const APP_PASSWORD = \".*\"/const APP_PASSWORD = \"${{ secrets.MULTIRIESGO_CONTRASENA }}\"/g" index.html
          
          echo "âœ… Credenciales inyectadas:"
          echo "   Usuario: ${{ secrets.MULTIRIESGO_USUARIO }}"
          echo "   ContraseÃ±a: [PROTEGIDA]"
      # ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ FIN NUEVO PASO ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add datos_actualizados.geojson index.html
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica de datos - $(date '+%Y-%m-%d %H:%M')"
          git push
      
      - name: Resumen final
        run: |
          echo "ğŸ‰ PROCESO COMPLETADO EXITOSAMENTE"
          echo "ğŸ“… Ãšltima actualizaciÃ³n: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŒ App disponible en: https://franciscotomatis.github.io/APP-C-rdoba/"
