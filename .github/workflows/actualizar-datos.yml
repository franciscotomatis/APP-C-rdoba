name: ğŸ¤– Actualizar datos automÃ¡ticamente

on:
  schedule:
    # Se ejecuta TODOS LOS DÃAS a las 8:00 AM (hora UTC-3 Argentina)
    - cron: '0 11 * * *'   # 11:00 UTC = 8:00 AM Argentina (UTC-3)
    
  # TambiÃ©n se puede ejecutar manualmente desde GitHub Actions
  workflow_dispatch:

# PERMISOS PARA QUE PUEDA HACER PUSH
permissions:
  contents: write  # â† ESTA LÃNEA ES CLAVE

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del repositorio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        # Configurar el token para permisos de escritura
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¤– Ejecutar script de descarga
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: python scripts/descargar_csv.py
    
    - name: ğŸ”„ Verificar archivo CSV
      run: |
        echo "ğŸ”„ Verificando archivo CSV..."
        if [ -f "datos_actualizados.csv" ]; then
          size=$(stat -f%z "datos_actualizados.csv" 2>/dev/null || stat -c%s "datos_actualizados.csv")
          echo "âœ… CSV encontrado, tamaÃ±o: $((size/1024/1024))M"
        else
          echo "âŒ No se encontrÃ³ datos_actualizados.csv"
          exit 1
        fi
    
    - name: ğŸ—ºï¸ Convertir CSV a GeoJSON
      run: python convertir_csv_a_geojson.py
    
    - name: ğŸ“Š Verificar GeoJSON generado
      run: |
        echo "ğŸ” Verificando GeoJSON..."
        if [ -f "datos_actualizados.geojson" ]; then
          size=$(stat -f%z "datos_actualizados.geojson" 2>/dev/null || stat -c%s "datos_actualizados.geojson")
          num_features=$(python -c "import json; f=open('datos_actualizados.geojson'); d=json.load(f); print(len(d['features']))" 2>/dev/null || echo "?")
          echo "âœ… GeoJSON generado: $((size/1024/1024))M, $num_features polÃ­gonos"
        else
          echo "âŒ No se generÃ³ datos_actualizados.geojson"
          exit 1
        fi
    
    - name: ğŸ“¤ Commit y push de cambios
      run: |
        echo "ğŸ“ Configurando Git..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        echo "ğŸ”„ Agregando archivos..."
        git add datos_actualizados.csv datos_actualizados.geojson
        
        echo "ğŸ’¾ Haciendo commit..."
        # Solo hacer commit si hay cambios
        if git diff --cached --quiet; then
          echo "âš ï¸  No hay cambios para commit"
        else
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica: $timestamp"
          
          echo "ğŸš€ Haciendo push..."
          git push
          echo "âœ… Cambios subidos a GitHub"
        fi
    
    - name: ğŸ“‹ Resumen final
      run: |
        echo "========================================"
        echo "âœ… PROCESO COMPLETADO EXITOSAMENTE"
        echo "========================================"
        echo "ğŸ“ ARCHIVOS PRINCIPALES:"
        echo "- datos_actualizados.csv"
        echo "- datos_actualizados.geojson"
        echo ""
        echo "ğŸ“… Ãšltima actualizaciÃ³n: $(date)"
        echo "========================================"
