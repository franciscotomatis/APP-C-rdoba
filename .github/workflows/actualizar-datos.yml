name: ü§ñ Actualizar datos autom√°ticamente

# CU√ÅNDO SE EJECUTA:
on:
  # 1. Manualmente desde la pesta√±a Actions
  workflow_dispatch:
  # 2. Cada d√≠a a las 8 AM (hora Argentina)
  schedule:
    - cron: '0 11 * * *'  # 11 AM UTC = 8 AM Argentina

jobs:
  actualizar:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Descargar el c√≥digo del repositorio
    - name: üì• Obtener c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Para poder hacer git push despu√©s
      
    # PASO 2: Configurar Python
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # PASO 3: Instalar dependencias del sistema
    - name: üñ•Ô∏è Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
    # PASO 4: Instalar dependencias de Python
    - name: üì¶ Instalar Python packages
      run: |
        pip install -r requirements.txt
        
    # PASO 5: Descargar CSV autom√°ticamente
    - name: ü§ñ Descargar CSV de multiriesgo-cba.com
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: |
        echo "üîê Iniciando descarga autom√°tica..."
        python scripts/descargar_csv.py
        
    # PASO 6: Convertir CSV a GeoJSON
    - name: üó∫Ô∏è Convertir a GeoJSON
      run: |
        echo "üîÑ Convirtiendo CSV a GeoJSON..."
        python convertir_excel_a_geojson.py
        
    # PASO 7: Verificar que se crearon los archivos
    - name: üîç Verificar archivos generados
      run: |
        echo "üìÅ Archivos en el directorio:"
        ls -la *.csv *.geojson *.json 2>/dev/null || echo "No hay archivos"
        echo ""
        echo "üìè Tama√±o de datos_actualizados.geojson:"
        if [ -f "datos_actualizados.geojson" ]; then
          du -h datos_actualizados.geojson
        else
          echo "‚ùå No se encontr√≥ datos_actualizados.geojson"
        fi
        
    # PASO 8: Actualizar el repositorio con los nuevos datos
    - name: üíæ Guardar cambios en GitHub
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Agregar archivos nuevos
        git add datos_actualizados.csv datos_actualizados.geojson
        
        # Agregar archivos de backup
        git add *.geojson *.csv
        
        # Hacer commit si hay cambios
        if git diff --cached --quiet; then
          echo "üì≠ No hay cambios para commitear"
        else
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica $(date +'%d/%m/%Y %H:%M')"
          git push
          echo "‚úÖ Cambios subidos a GitHub"
        fi
        
    # PASO 9: Mostrar resumen
    - name: üìä Resumen del proceso
      run: |
        echo "========================================"
        echo "‚úÖ PROCESO COMPLETADO"
        echo "========================================"
        echo "Los datos actualizados est√°n disponibles en:"
        echo "https://github.com/franciscotomatis/APP-C-rdoba"
        echo ""
        echo "üìÅ Archivos principales:"
        echo "- datos_actualizados.csv"
        echo "- datos_actualizados.geojson"
        echo ""
        echo "‚è∞ Pr√≥xima actualizaci√≥n autom√°tica: ma√±ana 8 AM"
