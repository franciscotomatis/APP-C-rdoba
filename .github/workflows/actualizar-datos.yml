name: ü§ñ Actualizar datos autom√°ticamente

on:
  schedule:
    # Se ejecuta TODOS LOS D√çAS a las 8:00 AM (hora UTC-3 Argentina)
    - cron: '0 11 * * *'   # 11:00 UTC = 8:00 AM Argentina (UTC-3)
    
  # Tambi√©n se puede ejecutar manualmente desde GitHub Actions
  workflow_dispatch:

# PERMISOS PARA QUE PUEDA HACER PUSH
permissions:
  contents: write  # ‚Üê ESTA L√çNEA ES CLAVE

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout del repositorio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        # Configurar el token para permisos de escritura
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ü§ñ Ejecutar script de descarga
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: python scripts/descargar_csv.py
    
    - name: üîÑ Verificar archivo CSV
      run: |
        echo "üîÑ Verificando archivo CSV..."
        if [ -f "datos_actualizados.csv" ]; then
          size=$(stat -f%z "datos_actualizados.csv" 2>/dev/null || stat -c%s "datos_actualizados.csv")
          echo "‚úÖ CSV encontrado, tama√±o: $((size/1024/1024))M"
        else
          echo "‚ùå No se encontr√≥ datos_actualizados.csv"
          exit 1
        fi
    
    - name: üó∫Ô∏è Convertir CSV a GeoJSON
      run: python convertir_csv_a_geojson.py
    
    - name: üìä Verificar GeoJSON generado
      run: |
        echo "üîç Verificando GeoJSON..."
        if [ -f "datos_actualizados.geojson" ]; then
          size=$(stat -f%z "datos_actualizados.geojson" 2>/dev/null || stat -c%s "datos_actualizados.geojson")
          num_features=$(python -c "import json; f=open('datos_actualizados.geojson'); d=json.load(f); print(len(d['features']))" 2>/dev/null || echo "?")
          echo "‚úÖ GeoJSON generado: $((size/1024/1024))M, $num_features pol√≠gonos"
        else
          echo "‚ùå No se gener√≥ datos_actualizados.geojson"
          exit 1
        fi

      - name: Inyectar credenciales en HTML
        run: |
          echo "üîê Inyectando credenciales en index.html..."
          
          # Verificar que index.html existe
          if [ ! -f "index.html" ]; then
            echo "‚ùå ERROR: index.html no encontrado"
            exit 1
          fi
          
          # Reemplazar credenciales con tus Secrets
          sed -i "s/const APP_USERNAME = \".*\"/const APP_USERNAME = \"${{ secrets.MULTIRIESGO_USUARIO }}\"/g" index.html
          sed -i "s/const APP_PASSWORD = \".*\"/const APP_PASSWORD = \"${{ secrets.MULTIRIESGO_CONTRASENA }}\"/g" index.html
          
          # Verificar que se reemplaz√≥
          echo "‚úÖ Credenciales inyectadas:"
          echo "   Usuario: ${{ secrets.MULTIRIESGO_USUARIO }}"
          echo "   Contrase√±a: [PROTEGIDA]"
          
          # Mostrar l√≠nea modificada (sin mostrar contrase√±a completa)
          grep -n "const APP_USERNAME" index.html || echo "‚ö†Ô∏è No se encontr√≥ APP_USERNAME"
          grep -n "const APP_PASSWORD" index.html | head -c 50 && echo "..."
    
    - name: üì§ Commit y push de cambios
      run: |
        echo "üìù Configurando Git..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        echo "üîÑ Agregando archivos..."
        git add datos_actualizados.csv datos_actualizados.geojson
        
        echo "üíæ Haciendo commit..."
        # Solo hacer commit si hay cambios
        if git diff --cached --quiet; then
          echo "‚ö†Ô∏è  No hay cambios para commit"
        else
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica: $timestamp"
          
          echo "üöÄ Haciendo push..."
          git push
          echo "‚úÖ Cambios subidos a GitHub"
        fi
    
    - name: üìã Resumen final
      run: |
        echo "========================================"
        echo "‚úÖ PROCESO COMPLETADO EXITOSAMENTE"
        echo "========================================"
        echo "üìÅ ARCHIVOS PRINCIPALES:"
        echo "- datos_actualizados.csv"
        echo "- datos_actualizados.geojson"
        echo ""
        echo "üìÖ √öltima actualizaci√≥n: $(date)"
        echo "========================================"
