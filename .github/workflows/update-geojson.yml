name: Update GeoJSON Data

on:
  schedule:
    - cron: '0 8,20 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip chromium-chromedriver
        
    - name: Install Python dependencies
      run: |
        cd scripts
        pip install -r requirements.txt
        
    - name: DEBUG - List files before
      run: |
        echo "ğŸ“ Estructura ANTES de ejecutar:"
        find . -type f -name "*.py" -o -name "*.txt" | sort
        echo ""
        echo "ğŸ“‚ Contenido de data/:"
        ls -la data/ 2>/dev/null || echo "No existe data/"
        
    - name: Download CSV (with credentials)
      env:
        MULTIRIESGO_USER: ${{ secrets.MULTIRIESGO_USER }}
        MULTIRIESGO_PASS: ${{ secrets.MULTIRIESGO_PASS }}
      run: |
        echo "ğŸš€ Iniciando descarga..."
        mkdir -p data
        cd scripts
        python download_csv.py
        
    - name: DEBUG - Check downloaded files
      run: |
        echo "ğŸ“‚ Archivos despuÃ©s de descarga:"
        ls -la data/ 2>/dev/null || echo "No hay archivos en data/"
        echo ""
        echo "ğŸ“„ Primeras lÃ­neas de CSV si existe:"
        head -5 data/*.csv 2>/dev/null || echo "No hay CSV"
        
    - name: Convert to GeoJSON
      run: |
        echo "ğŸ”„ Convirtiendo a GeoJSON..."
        cd scripts
        python convert_to_geojson.py
        
    - name: DEBUG - Check generated files
      run: |
        echo "ğŸ“‚ Archivos despuÃ©s de conversiÃ³n:"
        ls -la data/ 2>/dev/null || echo "No hay archivos"
        echo ""
        echo "ğŸ“ TamaÃ±o de GeoJSON si existe:"
        wc -l data/latest.geojson 2>/dev/null || echo "No hay GeoJSON"
        
    - name: Commit and push if changed
      if: success()
      run: |
        echo "ğŸ” Verificando cambios..."
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        # Verificar si existe el GeoJSON
        if [ -f "data/latest.geojson" ]; then
          echo "âœ… GeoJSON encontrado, agregando..."
          git add data/latest.geojson
          
          # Agregar reporte si existe
          git add data/conversion_report.json 2>/dev/null || true
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "ğŸ“­ No hay cambios en los datos"
          else
            git commit -m "ğŸ“Š Update GeoJSON data - $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Cambios subidos"
          fi
        else
          echo "âŒ ERROR: No se generÃ³ latest.geojson"
          echo "ğŸ“‚ Contenido actual de data/:"
          ls -la data/
          exit 1
        fi
