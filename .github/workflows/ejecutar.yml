name: Ejecutar Proceso Completo

on:
  schedule:
    # 8 AM y 8 PM UTC (5 AM y 5 PM Argentina)
    - cron: '0 8,20 * * *'
  workflow_dispatch:  # Para ejecutar manualmente

jobs:
  ejecutar:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Descargar repositorio
      uses: actions/checkout@v4
      
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ Instalar dependencias EXACTAS
      run: |
        pip install selenium==4.15.2
        pip install webdriver-manager
        pip install pandas openpyxl geopandas shapely
        pip install folium ipywidgets OWSLib
        sudo apt-get update
        sudo apt-get install -y chromium-chromedriver
        
    - name: ðŸš€ Ejecutar proceso completo
      env:
        USUARIO: ${{ secrets.USUARIO }}
        CONTRASENA: ${{ secrets.CONTRASENA }}
      run: |
        echo "ðŸ” Usuario: $USUARIO"
        mkdir -p data app
        python scripts/ejecutar_colab.py
        
    - name: ðŸ“¤ Subir archivos generados
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        # Verificar si hay archivos nuevos
        echo "ðŸ” Buscando archivos generados..."
        ls -la data/ 2>/dev/null || echo "No hay data/"
        ls -la app/ 2>/dev/null || echo "No hay app/"
        
        # Agregar archivos GeoJSON
        if [ -f "data/poligonos.geojson" ]; then
          git add data/poligonos.geojson
          echo "âœ… Agregado: data/poligonos.geojson"
        fi
        
        # Agregar archivos JSON
        if [ -f "data/datos.xlsx" ]; then
          git add data/datos.xlsx
          echo "âœ… Agregado: data/datos.xlsx"
        fi
        
        # Agregar HTML
        if [ -f "app/index.html" ]; then
          git add app/index.html
          echo "âœ… Agregado: app/index.html"
        fi
        
        # Verificar si hay cambios
        if git diff --cached --quiet; then
          echo "ðŸ“­ No hay cambios para commit"
        else
          git commit -m "ðŸ”„ ActualizaciÃ³n automÃ¡tica $(date '+%Y-%m-%d %H:%M')"
          git push
          echo "âœ… Cambios subidos a GitHub"
        fi
