name: Generar Aplicaci√≥n Web Multiriesgo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  generar-app:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        
    # 2. Python
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    # 3. Dependencias
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install geopandas pandas shapely folium selenium webdriver-manager lxml openpyxl
        pip install owslib branca
        
    # 4. LIMPIAR TODO ANTES
    - name: Limpiar todo
      run: |
        echo "üßπ LIMPIANDO TODO..."
        echo "Archivos ANTES de limpiar:"
        ls -la *.html *.geojson 2>/dev/null || echo "No hay archivos"
        
        # Eliminar archivos problem√°ticos
        rm -f appvieja.html index.html
        
        echo "Archivos DESPU√âS de limpiar:"
        ls -la *.html *.geojson 2>/dev/null || echo "No hay archivos"
        
    # 5. Descargar datos
    - name: Descargar datos de Multiriesgo
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: |
        echo "üöÄ EJECUTANDO script_geojson.py..."
        python script_geojson.py
        echo "‚úÖ script_geojson.py termin√≥"
        
    # 6. DEBUG: Ver qu√© pas√≥ despu√©s de script_geojson.py
    - name: DEBUG despu√©s de descarga
      run: |
        echo "üìÅ ¬øSe cre√≥ poligonos.geojson?"
        if [ -f "poligonos.geojson" ]; then
          echo "‚úÖ S√ç existe poligonos.geojson"
          ls -lh poligonos.geojson
        else
          echo "‚ùå NO existe poligonos.geojson"
          echo "üìÅ Archivos actuales:"
          ls -la
        fi
        
    # 7. DEBUG: Ver contenido de generar_visor.py
    - name: DEBUG ver script generar_visor.py
      run: |
        echo "üîç Revisando generar_visor.py..."
        echo "=== BUSCANDO 'output_file' en generar_visor.py ==="
        grep -n "output_file" generar_visor.py || echo "No encontr√© 'output_file'"
        echo "=== BUSCANDO 'save(' en generar_visor.py ==="
        grep -n "save(" generar_visor.py || echo "No encontr√© 'save('"
        echo "=== BUSCANDO 'index.html' en generar_visor.py ==="
        grep -n "index.html" generar_visor.py || echo "No encontr√© 'index.html'"
        
    # 8. Generar aplicaci√≥n
    - name: Generar aplicaci√≥n web
      run: |
        echo "üõ†Ô∏è EJECUTANDO generar_visor.py..."
        python generar_visor.py
        echo "‚úÖ generar_visor.py termin√≥"
        
    # 9. DEBUG: Ver qu√© archivos se crearon
    - name: DEBUG archivos creados
      run: |
        echo "üìÅ ARCHIVOS CREADOS DESPU√âS DE generar_visor.py:"
        ls -la *.html *.geojson 2>/dev/null || echo "No hay archivos"
        
        echo "üìÅ TODOS los archivos:"
        ls -la
        
    # 10. Si hay index.html, subirlo
    - name: Subir si se cre√≥ index.html
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -f "index.html" ]; then
          echo "üéâ ¬°index.html SE CRE√ì!"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add index.html poligonos.geojson
          
          if ! git diff --cached --quiet; then
            git commit -m "‚úÖ App generada: $(date '+%d/%m %H:%M')"
            git push
            echo "‚úÖ Subido a GitHub"
          else
            echo "‚ö†Ô∏è Sin cambios"
          fi
        else
          echo "‚ùå ERROR CR√çTICO: generar_visor.py NO cre√≥ index.html"
          echo "üí° Posibles causas:"
          echo "   1. Error en generar_visor.py"
          echo "   2. No guarda como index.html"
          echo "   3. Hay una excepci√≥n que detiene la ejecuci√≥n"
          exit 1
        fi
