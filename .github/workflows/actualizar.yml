name: Generar AplicaciÃ³n Web Multiriesgo

on:
  workflow_dispatch:  # Permite ejecuciÃ³n manual
  schedule:
    - cron: '0 8 * * *'
  push:
    branches: [ main ]
    paths:
      - 'script_geojson.py'
      - 'generar_visor.py'

jobs:
  generar-app:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout del cÃ³digo
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        
    # 2. Configurar Python
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    # 3. Instalar dependencias
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install geopandas pandas shapely folium selenium webdriver-manager lxml openpyxl
        pip install owslib branca
        
    # 4. Ejecutar script de descarga
    - name: Descargar datos de Multiriesgo
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: |
        echo "ğŸš€ Iniciando descarga automÃ¡tica..."
        python script_geojson.py
        
    # 5. Generar aplicaciÃ³n web
    - name: Generar aplicaciÃ³n web
      run: |
        echo "ğŸ› ï¸ Generando aplicaciÃ³n web..."
        python generar_visor.py
        
    # 6. Renombrar a index.html (SIEMPRE)
    - name: Renombrar HTML a index.html
      run: |
        echo "ğŸ“ Buscando archivos HTML..."
        ls -la *.html 2>/dev/null || echo "No hay HTML todavÃ­a"
        
        # SI existe app_generada.html, renombrarlo
        if [ -f "app_generada.html" ]; then
          echo "âœ… Encontrado: app_generada.html"
          cp app_generada.html index.html
          echo "ğŸ“„ index.html creado (copia de app_generada.html)"
        else
          echo "âŒ ERROR: No se encontrÃ³ app_generada.html"
          echo "ğŸ“ Listando todos los archivos para debug:"
          ls -la
          exit 1
        fi
        
    # 7. Configurar git
    - name: Configurar git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    # 8. Subir al repositorio
    - name: Subir archivos al repositorio
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ“¤ Subiendo archivos al repositorio..."
        
        # Agregar archivos especÃ­ficos
        git add index.html 2>/dev/null || true
        git add poligonos.geojson 2>/dev/null || true
        
        # Verificar si hay cambios
        if ! git diff --cached --quiet; then
          echo "ğŸ“ Haciendo commit..."
          git commit -m "ğŸ“± ActualizaciÃ³n automÃ¡tica: $(date '+%Y-%m-%d %H:%M')"
          
          echo "â¬†ï¸ Subiendo cambios..."
          git push
          echo "âœ… Cambios subidos exitosamente"
        else
          echo "âš ï¸ No hay cambios para commitear"
        fi
        
    # 9. Subir como artifact (opcional)
    - name: Subir como artifact
      uses: actions/upload-artifact@v4
      with:
        name: aplicacion-web-multiriesgo
        path: |
          index.html
          poligonos.geojson
        retention-days: 7
