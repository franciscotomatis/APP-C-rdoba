name: ActualizaciÃ³n AutomÃ¡tica Diaria

on:
  schedule:
    # 6 AM y 6 PM UTC (3 AM y 3 PM Argentina)
    - cron: '0 6,18 * * *'
  workflow_dispatch:
    inputs:
      motivo:
        description: 'Motivo de ejecuciÃ³n manual'
        required: false
        default: 'Prueba manual'

jobs:
  actualizar:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Descargar repositorio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ Instalar dependencias
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        pip install selenium webdriver-manager pandas openpyxl geopandas shapely
        
    - name: ğŸš€ Ejecutar proceso completo
      env:
        MULTIRIESGO_USUARIO: ${{ secrets.MULTIRIESGO_USUARIO }}
        MULTIRIESGO_CONTRASENA: ${{ secrets.MULTIRIESGO_CONTRASENA }}
      run: |
        echo "ğŸ” Usuario configurado"
        mkdir -p data
        python scripts/proceso_completo.py
        
    - name: ğŸ“¤ Subir cambios a GitHub
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        # Verificar quÃ© archivos se generaron
        echo "ğŸ“ Archivos generados en raÃ­z:"
        ls -la *.html *.json *.geojson 2>/dev/null || echo "No hay archivos en raÃ­z"
        
        echo "ğŸ“ Archivos generados en data/:"
        ls -la data/ 2>/dev/null || echo "No hay data/"
        
        # Agregar archivos ESPECÃFICOS
        if [ -f "data/poligonos.geojson" ]; then
          git add data/poligonos.geojson
          echo "âœ… Agregado: data/poligonos.geojson"
        fi
        
        if [ -f "data/poligonos_actualizados.geojson" ]; then
          git add data/poligonos_actualizados.geojson
          echo "âœ… Agregado: data/poligonos_actualizados.geojson"
        fi
        
        if [ -f "data/datos_actualizados.xlsx" ]; then
          git add data/datos_actualizados.xlsx
          echo "âœ… Agregado: data/datos_actualizados.xlsx"
        fi
        
        if [ -f "data/datos_prueba.xlsx" ]; then
          git add data/datos_prueba.xlsx
          echo "âœ… Agregado: data/datos_prueba.xlsx"
        fi
        
        # IMPORTANTE: HTML en RAÃZ
        if [ -f "index.html" ]; then
          git add index.html
          echo "âœ… Agregado: index.html (EN RAÃZ)"
        fi
        
        # TambiÃ©n buscar en app/ por si acaso
        if [ -f "app/index.html" ]; then
          git add app/index.html
          echo "âœ… Agregado: app/index.html (backup)"
        fi
        
        # Verificar si hay archivos para commit
        echo "ğŸ” Verificando cambios..."
        if git status --porcelain | grep -q "."; then
          echo "ğŸ“ Hay cambios, haciendo commit..."
          git commit -m "ğŸ”„ ActualizaciÃ³n automÃ¡tica - $(date '+%d/%m/%Y %H:%M')"
          git push
          echo "âœ… Cambios subidos a GitHub"
        else
          echo "ğŸ“­ No hay cambios para commit"
        fi
